<apex:page standardController="Im_Investigation__c" extensions="IncidentInvestigation" id="wholePage">
	<apex:stylesheet value="{!URLFOR($Resource.mentoresd,'/mentoresdcss2.css')}" />
	<apex:stylesheet value="{!URLFOR($Resource.DataTables1109, 'jquery-ui-1.11.4.custom/jquery-ui.min.css')}" />

	<apex:includeScript value="{!URLFOR($Resource.DataTables1109, 'jQuery-2.1.4/jquery-2.1.4.min.js')}" />
	<apex:includeScript value="{!URLFOR($Resource.DataTables1109, 'jquery-ui-1.11.4.custom/jquery-ui.min.js')}" />

	<apex:includeScript value="{!URLFOR($Resource.IncidentJS)}" />

	<style>
		#wholeTable {
			width: 100%;
		}

		td#page-sidebar {
			width: 300px;
		}

		td#page-sidebar .bPageBlock .pbTitle {
			width: 90%;
		}

		.thinking {
			opacity: 0.8;
			background-color: #ccc;
			position: fixed;
			width: 100%;
			height: 100%;
			top: 0px;
			left: 0px;
			z-index: 100000;
		}
		.thinkingwheel {
			position: absolute;
			left: 40%;
			top: 48%;
			background-color: white;
			border: 2px solid gray;
			padding: 2px;
		}
	</style>
	<table id="wholeTable">
		<tr>
			<td id="page-sidebar">
				<c:IncidentSidebar parentId="{!Im_Investigation__c.Im_Incident__c}" investigationSectionActive="true" currentRecordId="{!Im_Investigation__c.Id}" />
			</td>
			<td id="page-body">
				<apex:pageMessages id="pageMessages"></apex:pageMessages>
				<apex:form id="wholeForm">
					<apex:actionFunction name="save" action="{!save}" />
					<apex:actionFunction name="disregard" action="{!disregard}" />
					<apex:actionFunction name="finalize" action="{!finalize}" />
					<apex:actionFunction name="createNewManualAssociation" action="{!createNewManualAssociation}" oncomplete="Incident.openModalDialogById('{!$Component.manualAssociationModal}', '{!$Component.wholeForm}', { titleString: 'Associate Related Incident' });" status="pageStatus" rerender="{!$Component.manualAssociationModal}" />
					<apex:actionFunction name="createNewAutoAssociation" action="{!createNewAutoAssociation}" oncomplete="Incident.openModalDialogById('{!$Component.autoAssociationModal}', '{!$Component.wholeForm}', { titleString: 'Associate Related Incident' });" status="pageStatus" rerender="{!$Component.autoAssociationModal}">
						<apex:param name="lookedUpIncidentId" value="" assignTo="{!lookedUpIncidentId}" />
					</apex:actionFunction>
					<apex:actionFunction name="saveManualAssociation" action="{!saveManualAssociation}" oncomplete="Incident.closeModalDialogById('{!$Component.manualAssociationModal}')" rerender="{!$Component.mainBlock.associationSection.associationTable}" status="pageStatus" />
					<apex:actionFunction name="saveAutoAssociation" action="{!saveAutoAssociation}" oncomplete="Incident.closeModalDialogById('{!$Component.autoAssociationModal}')" rerender="{!$Component.mainBlock.associationSection.associationTable}" status="pageStatus" />

					<apex:pageBlock title="Investigation Plan for {!Im_Investigation__c.Im_Incident__r.Name} - {!Im_Investigation__c.Status__c}" id="mainBlock">
						<apex:pageBlockButtons location="top">
							<div style="float: right" id="pageBlockButtons">
								<apex:outputPanel layout="none" rendered="{!isEditMode}">
									<a class="btn" onclick="save(); return false;">Save</a>
									<a class="btn" href="/apex/IncidentInvestigation?id={!Im_Investigation__c.Id}">Cancel</a>
								</apex:outputPanel>

								<apex:outputPanel layout="none" rendered="{!isViewMode && !isLocked}">
									<a class="btn" href="/apex/IncidentInvestigation?id={!Im_Investigation__c.Id}&mode=edit">Edit</a>
									<a class="btn" onclick="disregard(); return false;">Disregard</a>
									<a class="btn" onclick="finalize(); return false;">Finalize</a>
								</apex:outputPanel>
							</div>
						</apex:pageBlockButtons>

						<apex:pageBlockSection id="overall" columns="1" rendered="{!isEditMode}">
							<apex:pageBlockSectionItem >
								<label for="startDate_pickerId">Investigation Start Date</label>
								<apex:outputPanel layout="none">
									<div class="requiredInput">
										<div class="requiredBlock"></div>
										<c:UserPreferredTimePicker edit="true" hiddenFieldId="startDate" dateTimeVal="{!Im_Investigation__c.Investigation_Start_Date__c}" datetimepickerid="startDate_pickerId" />
										<apex:inputHidden value="{!Im_Investigation__c.Investigation_Start_Date__c}" id="startDate" />
									</div>
								</apex:outputPanel>
							</apex:pageBlockSectionItem>

							<apex:pageBlockSectionItem >
								<label for="endDate_pickerId">Investigation End Date</label>
								<apex:outputPanel layout="none">
									<c:UserPreferredTimePicker edit="true" hiddenFieldId="endDate" dateTimeVal="{!Im_Investigation__c.Investigation_End_Date__c}" datetimepickerid="endDate_pickerId" />
									<apex:inputHidden value="{!Im_Investigation__c.Investigation_End_Date__c}" id="endDate" />
								</apex:outputPanel>
							</apex:pageBlockSectionItem>

							<apex:inputField value="{!Im_Investigation__c.External_Investigating_Parties__c}" />

							<apex:inputField value="{!Im_Investigation__c.Attorney_Involvement__c}" />

							<apex:inputField value="{!Im_Investigation__c.Background_of_Placement__c}" style="width: 50%" />
						</apex:pageBlockSection>

						<apex:pageBlockSection columns="1" rendered="{!isViewMode}">
							<apex:pageBlockSectionItem >
								<apex:outputLabel value="Investigation Start Date" />
								<c:UserPreferredTimePicker dateTimeVal="{!Im_Investigation__c.Investigation_Start_Date__c}" />
							</apex:pageBlockSectionItem>

							<apex:pageBlockSectionItem >
								<apex:outputLabel value="Investigation End Date" />
								<c:UserPreferredTimePicker dateTimeVal="{!Im_Investigation__c.Investigation_End_Date__c}" />
							</apex:pageBlockSectionItem>

							<apex:outputField value="{!Im_Investigation__c.External_Investigating_Parties__c}" />

							<apex:outputField value="{!Im_Investigation__c.Attorney_Involvement__c}" />

							<apex:outputField value="{!Im_Investigation__c.Background_of_Placement__c}" />
						</apex:pageBlockSection>

						<apex:pageBlockSection title="Conclusion" rendered="{!isEditMode}" collapsible="false" columns="1">
							<apex:inputField value="{!Im_Investigation__c.Factual_Findings__c}" style="width: 50%" />
							<apex:inputField value="{!Im_Investigation__c.Conclusion_of_Fact__c}" />
							<apex:inputField value="{!Im_Investigation__c.Summary_on_Conclusion__c}" style="width: 50%" />
						</apex:pageBlockSection>

						<apex:pageBlockSection title="Conclusion" rendered="{!isViewMode}" collapsible="false" columns="1">
							<apex:outputField value="{!Im_Investigation__c.Factual_Findings__c}" />
							<apex:outputField value="{!Im_Investigation__c.Conclusion_of_Fact__c}" />
							<apex:outputField value="{!Im_Investigation__c.Summary_on_Conclusion__c}" />
						</apex:pageBlockSection>

						<apex:pageBlockSection title="Potential Related Incidents" collapsible="false" columns="1" id="associationSection">
							<div style="float: right;">
								<apex:commandButton onclick="showAssociationDialog(); return false;" value="Associate Incident" />
							</div>
							<apex:pageBlockTable id="associationTable" value="{!incidentAssociations}" var="association">
								<apex:column value="{!association.incidentNumber}" headerValue="Incident Number" />
								<apex:column value="{!association.dateOfIncident}" headerValue="Date of Incident" />
								<apex:column value="{!association.finalLevel}" headerValue="Final Level" />
								<apex:column value="{!association.programAssociation}" headerValue="Program Association" />
								<apex:column value="{!association.source}" headerValue="Source" />
								<apex:column value="{!association.comment}" headerValue="Comment" />
								<apex:column value="{!association.dateOfAssociation}" headerValue="Date of Association" />
								<apex:column value="{!association.associationMadeBy}" headerValue="Association Made By" />
							</apex:pageBlockTable>
						</apex:pageBlockSection>
					</apex:pageBlock>

					<apex:outputPanel id="manualAssociationModal" style="display:none;">
						<apex:pageBlock title="Associate Related Incident" >
							<apex:pageMessages id="manualAssociationMessages" />
							<apex:pageBlockButtons location="bottom">
								<apex:commandButton onclick="saveManualAssociation(); return false;" value="Save" />
								<apex:commandButton onclick="Incident.closeModalDialogById('{!$Component.manualAssociationModal}'); return false;" value="Cancel" />
							</apex:pageBlockButtons>
							<apex:pageBlockSection columns="1">
								<apex:inputField value="{!currentManualAssociation.Incident_Number__c}" />
								<apex:inputField value="{!currentManualAssociation.Date_of_Incident__c}" />
								<apex:inputField value="{!currentManualAssociation.Final_Level__c}" />
								<apex:inputField value="{!currentManualAssociation.Program_Association__c}" />
								<apex:inputField value="{!currentManualAssociation.Source__c}" />
								<apex:inputField value="{!currentManualAssociation.Comment__c}" />
								<apex:inputField value="{!currentManualAssociation.Date_of_Association__c}" />
								<apex:inputField value="{!currentManualAssociation.Association_Made_By__c}" />
							</apex:pageBlockSection>
						</apex:pageBlock>
					</apex:outputPanel>

					<apex:outputPanel id="autoAssociationModal" style="display:none;">
						<apex:pageBlock title="Associate Related Incident" >
							<apex:pageMessages id="autoAssociationMessages" />
							<apex:pageBlockButtons location="bottom">
								<apex:commandButton onclick="saveAutoAssociation(); return false;" value="Save" />
								<apex:commandButton onclick="Incident.closeModalDialogById('{!$Component.autoAssociationModal}'); return false;" value="Cancel" />
							</apex:pageBlockButtons>
							<apex:pageBlockSection columns="1">
								<apex:outputField value="{!currentAutoAssociation.ImIncident__r.Name}" />
								<apex:outputField value="{!currentAutoAssociation.ImIncident__r.Date_Documented__c}" />
								<apex:outputField value="{!currentAutoAssociation.ImIncident__r.Final_Level__c}" />
								<apex:outputField value="{!currentAutoAssociation.ImIncident__r.Service_Location__r.Name}" />
								<apex:inputField value="{!currentAutoAssociation.Source__c}" />
								<apex:inputField value="{!currentAutoAssociation.Comment__c}" />
								<apex:inputField value="{!currentAutoAssociation.Date_of_Association__c}" />
								<apex:inputField value="{!currentAutoAssociation.Association_Made_By__c}" />
							</apex:pageBlockSection>
						</apex:pageBlock>
					</apex:outputPanel>

					<apex:outputPanel id="incidentLookupModal"  style="display:none;">
						<c:IncidentLookup finalizedOnly="true" onIncidentChosen="incidentCallback" />
					</apex:outputPanel>
				</apex:form>
				<c:SObjectNotesAndAttachments parentId="{!Im_Investigation__c.Id}" showAction="{!!isLocked}" showAdd="{!!isLocked}" />
			</td>
		</tr>
	</table>
	<div id="associationDialog" style="display: none; " class="dialog" title="Associate Related Incident">
		<p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>Did the incident occur before 10/01/2016?</p>
	</div>
	<apex:actionStatus id="pageStatus" layout="block">
		<apex:facet name="start">
			<div class="thinking">
				<div class="thinkingwheel">
					<span><img class="waitingImage" src="/img/loading.gif" title="Please Wait..." />&nbsp; Processing...</span>
				</div>
			</div>
		</apex:facet>
		<apex:facet name="stop"></apex:facet>
	</apex:actionStatus>

	<script>
	function setFocusOnLoad() {}
	jQuery.noConflict();
	jQuery(document).ready(function ($) {
		"use strict";
		window.showAssociationDialog = function () {
			$("#associationDialog").dialog({
				resizable: false,
				autoOpen: true,
				height: 180,
				modal: true,
				buttons: {
					"Yes": function() {
						$(this).dialog("close");
						createNewManualAssociation();
					},
					"No": function() {
						$(this).dialog("close");
						Incident.openModalDialogById('{!$Component.wholeForm.incidentLookupModal}', '{!$Component.wholeForm}', { titleString: 'Find Incident' });
					}
				}
			});
		};
		window.incidentCallback = function (incidentId) {
			Incident.closeModalDialogById('{!$Component.wholeForm.incidentLookupModal}');
			createNewAutoAssociation(incidentId);
		};
	});
	</script>
</apex:page>