<apex:page title="Shift Notes" Controller="EvalDynamicExt" standardStylesheets="true" sidebar="false" tabStyle="Persons_Being_Served_New__tab" showheader="true">
	<style> <!-- Move this to the top of the page so the user doesn't see a flash -->
		#tabContainer {
			display: none;
		}
	</style>
	<!-- Bootstrap core CSS -->
	<apex:stylesheet value="{!URLFOR($Resource.EvalBootstrap, 'css/bootstrap.css')}" />
	<!-- Custom styles for this template -->
	<apex:stylesheet value="{!URLFOR($Resource.EvalBootstrap, 'css/blog.css')}" />

	<!--
	<apex:stylesheet value="{!URLFOR($Resource.mentoresd,'/mentoresd.css')}" />
	-->

	<!-- Bootstrap core JavaScript-->
<!--     <apex:includeScript value="{!URLFOR($Resource.EvalBootstrap, 'js/jquery.min.js')}" /> -->
<!--     <apex:includeScript value="{!URLFOR($Resource.EvalBootstrap, 'js/bootstrap.min.js')}" /> -->
<!--     <apex:includeScript value="{!URLFOR($Resource.EvalBootstrap, 'js/docs.min.js')}" /> -->

	<apex:includeScript value="{!URLFOR($Resource.jquery, '/js/jquery-1.7.2.min.js')}" />
	<apex:includeScript value="{!URLFOR($Resource.jquery, 'js/jquery-ui-1.8.21.custom.min.js')}" />
	<apex:includeScript value="{!URLFOR($Resource.jquery, '/JQ/jquery-ui.min.js')}" />
    <apex:stylesheet value="{!URLFOR($Resource.chosen, '/chosen.css')}"/>
    <apex:includescript value="{!URLFOR($Resource.chosen, '/chosen.jquery.js')}" />

	<apex:pageMessages id="msgs" />
	<script>
		var isModified = false;
		var evaltype = null;
		var cat = null;
		var subCat = null;
		var evalSectionId = null;
		var evalSectionType = null;
		var canEdit = null;


		jQuery(function ($) {
        	$('.collapsearrow').on("click", function (e) {
            if ($(this).hasClass('panel-collapsed')) {
                // expand the panel
                $(this).parents('.inset').find('.panelshrink').slideDown();
                $(this).removeClass('panel-collapsed');
                $(this).find('i').removeClass('glyphicon-chevron-down').addClass('glyphicon-chevron-up');
            }
            else {
                // collapse the panel
                $(this).parents('.inset').find('.panelshrink').slideUp();
                $(this).addClass('panel-collapsed');
                $(this).find('i').removeClass('glyphicon-chevron-up').addClass('glyphicon-chevron-down');
            }
        	});
    		});

		function clearPanel() {
   			jQuery("[id$='panel-panel-info']").empty().removeClass('panel panel-info');
			isModified = false;
		}

		function showReporting() {
			//set up the attributes
			// hide the old panel
			jQuery("#panel-form").empty().append(jQuery("[id$='goalobjreportform']"));
			}

		function showForm(key) {
			if (key.indexOf('Head to Toe~Skin/Body~Wound Detail') > -1 || key.indexOf('Head to Toe~Skin/Body~Pressure Ulcer Details') > -1 || key.indexOf('Residential~Skin/Body~Pressure Ulcer Detail') > -1 || key.indexOf('Residential~Skin/Body~Wound Detail') > -1 ) {
        		jQuery("#panel-form").empty().append(jQuery("[id$='evalResponsesForm']"));
    		}
    		else if(key == 'Residential~Fall Risk Assessment~Fall Assessment~Residential' || key == 'Residential~Skin/Body~Skin Assessment~Residential'){
        		jQuery("#panel-form").empty().append(jQuery("[id$='assessmentForm']"));
    		}
    		else if(key.indexOf('Restraint Event~Reduction Review~Reduction Review') > -1){
    			jQuery("#panel-form").empty().append(jQuery("[id$='restraintForm']"));
    		}
    		else{
        		jQuery("#panel-form").empty().append(jQuery("[id$='evalForm']"));
				bindSubmitEvent();
				setUpFields();
		        jQuery('#evalSecValMsgs').html(jQuery('#ErrorMsg').val());
			}
			isModified = true;
		}

		function setupButtons(disableFlag) {
			if (disableFlag) {
                jQuery("#btnESign").removeClass('btn-success').addClass('btn-danger');
                jQuery("#btnESign").removeAttr('onclick');
				jQuery("#btnEsign").removeAttr('href');

				jQuery("#btnDone").removeClass('btn-success').addClass('btn-danger');
                jQuery("#btnDone").removeAttr('onclick');
				jQuery("#btnDone").removeAttr('href');

                }
			else {
                jQuery("#btnESign").removeClass('btn-danger').addClass('btn-success');
                jQuery("#btnESign").attr('onclick','authenticate();');
                jQuery("#btnESign").attr('href','#');

                jQuery("#btnDone").removeClass('btn-danger').addClass('btn-success');
                jQuery("#btnDone").attr('onclick','authenticate();');
                jQuery("#btnDone").attr('href','#');

                }
            jQuery("#btnESign").prop('disabled', disableFlag);

            jQuery("#btnDone").prop('disabled', disableFlag);

		}

		function revise() {
			var r = confirm('Revising this Assessment will create a new Draft and you will be redirected to the new one');
			if (r == true) {
				reviseAssessment();
			} else {
				return null;
			}

		}

		function disregard(evalType) {

			if (evalType == 'Residential') {
				disregardAssessment();
			}

			if (evalType == 'Head to Toe') {
				var c = confirm('Disregarding this Assessment will create a new Draft and you will be redirected to the new one');
				if (c == true) {
					disregardAssessment();
				} else {
					return null;
				}
			}

			if(evalType == 'Restraint Event'){
				disregardAssessment();
			}
		}

		filterNavigation = function(){
		    var filter = jQuery('#filter').val().toLowerCase();
		    jQuery('.sidebar-module.sidebar-module-inset > span > div').each(function() {
			    var _this = jQuery(this);
			    var title = _this.find('.panel-title').prop("innerHTML").split(" --")[0].toLowerCase();

			    if (title.indexOf(filter) < 0 && filter != '--none--') {
			        _this.hide();
			    } else {
			        _this.show();
			    }
		    });
		}

		jQuery(document).ready(function($) {

			var titles = [];
			var uniquetitle = [];
			$('.sidebar-module.sidebar-module-inset > span > div > div .panel-title').each(function() {
		        var _this = $(this);
		        var title = _this.prop("innerHTML").split(" --")[0];
		        titles.push(title);
			});
			$.each(titles, function(i, el){
			    if($.inArray(el, uniquetitle) === -1) uniquetitle.push(el);
			});
		    $.each(uniquetitle, function(){
		        $('#filter')
		          .append($("<option></option>")
		          .attr("value",this)
		          .text(this));
		    });
		    $('#filter').chosen().change(filterNavigation);

			$("[id$='dialog-confirm-navigation']").dialog({
				resizable: false,
                draggable: false,
				height: 200,
				modal: true,
				autoOpen: false,
				buttons: {
					Yes: function() {
                        jQuery( this ).dialog( "close" );
						isModified = false;
                        jQuery('#btnSave').trigger("click");
                        createPanelAF(evaltype, cat, subCat, evalSectionId, evalSectionType, canEdit);
					},
					No: function() {
                        jQuery( this ).dialog( "close" );
						isModified = false;
						createPanelAF(evaltype, cat, subCat, evalSectionId, evalSectionType, canEdit);
					},
                Cancel: function() {
                        jQuery( this ).dialog( "close" );
                    }
			     }
			});

		});

		window.createPanel = function(evaltype1, cat1, subCat1, evalSectionId1, evalSectionType1, canEdit1) {
			evaltype = evaltype1;
			cat = cat1,
				subCat = subCat1,
				evalSectionId = evalSectionId1,
				evalSectionType = evalSectionType1,
				canEdit = canEdit1;
			if (isModified && canEdit) {
				jQuery("[id$='dialog-confirm-navigation']").dialog("open");
			} else {
				createPanelAF(evaltype, cat, subCat, evalSectionId, evalSectionType, canEdit);
			}
		}
	</script>
	<style>
		.ui-dialog.ui-widget.ui-widget-content.ui-corner-all.modalDialog.ui-draggable {
			left: 50% !important;
			margin: 0 0 0 -488px;
		}
		.chosen-single {
		    background-color: white !important;
		    background-image:none !important;
		    box-shadow:none !important;
		    border-radius:0px !important;
		}
	</style>

	<c:PersonalRecord pbsId="{!PBSID}" servAssignId="{!SAID}" parentPage="Evaluation" servAssignNew="false" admId="{!AdmId}" />
	<div class="container">
		<div class="blog-header"></div>
		<div class="row">
			<div class="col-sm-4">
				<div class="sidebar-module-sm-no-scroll sidebar-module-inset">
					<apex:outputPanel rendered="{!evalType == 'Head to Toe'}">
						<h4>Nurse: {!thisEval.Owner.Name}</h4>
                        <p>Head to Toe Status: {!thisEval.Head_to_Toe_Status__c}<br/> Shift Status:{!thisEval.Status__c} {!evalStatusDate} </p>
					</apex:outputPanel>

					<apex:outputPanel rendered="{!evalType == 'Residential'}">
						<h4>Nurse: {!thisEval.Owner.Name}</h4>
                        <p>Status:{!thisEval.Status__c} (<apex:outputText value="{!evalStatusDate}" />)</p>
					</apex:outputPanel>

					<apex:outputPanel rendered="{!evalType == 'Restraint Event'}">
						<p>
						   Restraint Status:{!thisEval.Status__c}<br/>
                           CreatedDate: <apex:outputText value=" {!shiftCreatedDate}" /> <br/>
                           <apex:variable value="" var="a" rendered="{!thisEval.Status__c == 'Applied Alternative to Restraint' || thisEval.Status__c == 'Applied Restraint'}" >
						   		Restrained By: {!thisEval.Owner.Name} <br/>
						   </apex:variable>
						   <apex:variable value="" var="b" rendered="{!thisEval.Shift_Start_Time__c != null}" >
						   		Start Date/Time : {!shiftStartTime}<br/>
						   </apex:variable>
						   <apex:variable value="" var="c" rendered="{!thisEval.Shift_End_Time__c != null}" >
						   		End Date/Time :{!shiftEndTime}
						   </apex:variable>
						</p>
					</apex:outputPanel>

					<apex:outputPanel >
						<a id="btnPrint" class="btn-info btn-sm centered" href="/apex/EvalLogView?evalID={!$CurrentPage.parameters.evalId}&evalname={!$CurrentPage.parameters.evalType}&opGrp={!$CurrentPage.parameters.opGrp}" target="_blank" role="button">View Summary</a>
					</apex:outputPanel>
					<br/>
					<apex:outputPanel rendered="{!showEsign}">
						<a id="btnESign" class="btn-success btn-sm pull-left" href="#" role="button" onClick="authenticate(); return false;">Finalize {!evalType}</a>
					</apex:outputPanel>

					<apex:outputPanel rendered="{!showRevise}">
						<a id="btnRevise" class="btn-success btn-sm pull-left" href="#" role="button" onClick="revise(); return false;">Revise {!evalType}</a>
					</apex:outputPanel>

					<apex:outputPanel rendered="{!showshiftDone}">
						<a id="btnDone" class="btn-success btn-sm pull-left" href="#" role="button" onClick="authenticate(); return false;">Complete {!evalType}</a>
					</apex:outputPanel>

					<apex:outputPanel rendered="{!showDisregard}">
						<a id="btnDisregard" class="btn-success btn-sm pull-right" href="#" role="button" onClick="disregard('{!evalType}'); return false;">Disregard {!evalType}</a>
					</apex:outputPanel>
				</div>

               <label for="filter" >Section :&nbsp;</label><select id="filter" size="1" class="chosenSelect" value=""><option value="--None--">--All--</option></select>

				<apex:outputPanel rendered="{!evalType != 'Residential'}">
				<div class="sidebar-module-inset sidebar-module-sm-no-scroll" style="height:auto;text-align:left" >
				<div id="objreportingpanel" class="inset">
				<h4>Plan Reporting</h4>
				<span class="pull-right collapsearrow"><i class="glyphicon glyphicon-chevron-up"></i></span>
					<apex:outputPanel id="goalObjRepeaters" layout="block" styleclass="panelshrink">
						<c:GoalObjRepeaters parentID="{!SAID}"  opGrp="{!$CurrentPage.parameters.opGrp}" start="{!thisEval.Shift_Start_Time__c}" />
					</apex:outputPanel>
					</div>
				</div>

				</apex:outputPanel>
 				<div class="sidebar-module sidebar-module-inset">
					<apex:outputPanel id="evalRepeaters" layout="none">
						<c:EvalRepeaters parentID="{!$CurrentPage.parameters.evalId}" evaltype="{!$CurrentPage.parameters.evalType}" opGrp="{!$CurrentPage.parameters.opGrp}" />
					</apex:outputPanel>
				</div>
				<!-- sidebar-module -->
			</div>
			<!-- /.blog-sidebar -->

			<div class="col-sm-8 blog-main">
				<apex:outputPanel id="evalFormBody" styleClass="blog-post" layout="block">
					<apex:outputPanel id="panel-panel-info" styleClass="panel panel-info" layout="block" rendered="{! cat != ''}">
						<div class="panel-heading clearfix">
							<h3 class="panel-title pull-left">{!$CurrentPage.parameters.Category}/{!$CurrentPage.parameters.SubCategory} -- {! evaltype}</h3>
						</div>
						<div id="panel-form" class="panel-body">

						</div>
					</apex:outputPanel>

				</apex:outputPanel>
				<!-- /.blog-post -->
			</div>
			<!-- /.blog-main -->
		</div>
		<!-- /.row -->
	</div>
	<!-- /.container -->

	<apex:form id="wholePage">
        <apex:actionFunction name="createPanelAF" action="{!myAction}" rerender="evalFormBody,evalRepeaters, outputsection, assessments, restraintReduction, evalResponsesSection" status="myStatus" oncomplete="showForm('{!evalType+'~'+cat+'~'+subCat+'~'+evalSecType}');filterNavigation();">
			<apex:param name="evaltype" value="" AssignTo="{!evalType}" />
			<apex:param name="Category" value="" AssignTo="{!cat}" />
			<apex:param name="SubCategory" value="" AssignTo="{!subCat}" />
			<apex:param name="evalSectionId" value="" AssignTo="{!evalSecId}" />
			<apex:param name="evalSectionType" value="" AssignTo="{!evalSecType}" />
			<apex:param name="canEdit" value="" />
		</apex:actionFunction>
        <apex:actionFunction name="refreshEvalRepeaters" rerender="evalRepeaters" status="myStatus" oncomplete="filterNavigation();"/>
		<c:Authentication formId="{!$Component.wholePage}" title="E-Sign" handler="CMShiftAssessmentEsign" objectId="{!$CurrentPage.parameters.evalId}" oncomplete="alert('This document was electronically signed by {!$User.FirstName} ({!$User.Email}) on {!NOW()}'); location.reload(true); return false;" />
		<apex:actionFunction name="reviseAssessment" action="{!reviseAssessment}" status="myStatus" reRender="msgs" />
		<apex:actionFunction name="disregardAssessment" action="{!disregardAssessment}" status="myStatus" reRender="msgs" />
		<apex:actionfunction name="completeShift" action="{!completeShift}" status="myStatus" reRender="msgs" />
		<apex:actionregion >
		<apex:actionfunction name="rerenderGoalObjRpt" rerender="evalFormBody, pnlgoalobjReporting" status="myStatus" onComplete="showReporting();">
			<apex:param name="evaltype" value="" AssignTo="{!evalType}" />
			<apex:param name="Category" value="" AssignTo="{!cat}" />
			<apex:param name="SubCategory" value="" AssignTo="{!subCat}" />
			<apex:param name="currobjID" value="" />
			<apex:param name="currobjType" value="" />
 		</apex:actionfunction>
 		</apex:actionregion>
	</apex:form>

	<c:EvalSection id="outputsection" uniqueId="abc" category="{!$CurrentPage.parameters.Category}" subcategory="{!$CurrentPage.parameters.SubCategory}" evaltype="{!$CurrentPage.parameters.evaltype}" evalSectionUuid="{!$CurrentPage.parameters.evalSectionId}" evalSectionType="{!$CurrentPage.parameters.evalSectionType}" editEnabled="{!$CurrentPage.parameters.canEdit}" parentID="{!$CurrentPage.parameters.evalId}" rendered="{!showMainComponent}" onEntrySaveSuccess="clearPanel(); refreshEvalRepeaters(); " />

	<apex:outputPanel style="display:none" id="assessments">
		<apex:form id="assessmentForm">
			<c:fallAssessmentComponent Domain="Fall Risk Assessment Domain" rendered="{!key == 'Residential~Fall Risk Assessment~Fall Assessment~Residential'}" AssessmentName="Fall Risk Assessment" lowerScore="1" medianScore="30" higherScore="31" />
			<c:fallAssessmentComponent Domain="Skin Assessment Domain" rendered="{!key == 'Residential~Skin/Body~Skin Assessment~Residential'}" AssessmentName="Skin Assessment" lowerScore="1" medianScore="14" higherScore="14" />
			<input class="btn" type="button" style="align:center;" value="Close" onclick="clearPanel();" />
		</apex:form>
	</apex:outputPanel>

	<apex:outputPanel style="display: none" id="restraintReduction" >
		<apex:form id="restraintForm" >
			<c:restraintReductionComponent rendered="{!key == 'Restraint Event~Reduction Review~Reduction Review~Restraint Event' || key=='Restraint Event~Reduction Review~Reduction Review~Activity Log'}" AssessmentId="{!currentAssessId}"/>
			<input class="btn" type="button" style="float:center;" value="Close" onclick="clearPanel();" />

		</apex:form>
	</apex:outputPanel>

 	<apex:outputPanel style="display:none" id="pnlgoalobjReporting" rendered="{!evalType != 'Residential'}">
			<c:GoalObjReporting id="compGoalObj" type="{!$CurrentPage.parameters.currObjType}" oid="{!$CurrentPage.parameters.currObjId}" sid="{!SAID}" startdate="{!thisEval.Shift_Start_Time__c}"/>
	</apex:outputPanel>

	<apex:outputPanel id="evalResponsesSection" style="display:none">
		<apex:form id="evalResponsesForm">
			<apex:pageBlock >
        <c:EvaluationResponseTable parentID="{!$CurrentPage.parameters.evalId}" type="Wound Detail" showTitle="false" collapsible="false" formId="{!$Component.evalResponsesForm}" uniqueId="wound" rendered="{!key == 'Head to Toe~Skin/Body~Wound Detail~Head to Toe' || key == 'Residential~Skin/Body~Wound Detail~Residential'}"/>
        <c:EvaluationResponseTable parentID="{!$CurrentPage.parameters.evalId}" type="Wound Detail Log" showTitle="false" collapsible="false" formId="{!$Component.evalResponsesForm}" uniqueId="woundLog" rendered="{!key == 'Head to Toe~Skin/Body~Wound Detail~Activity Log'}"/>
        <c:EvaluationResponseTable parentId="{!$CurrentPage.parameters.evalId}" type="Pressure Ulcer Detail" showTitle="false" collapsible="false" formId="{!$Component.evalResponsesForm}" uniqueId="decubiti" rendered="{!key == 'Head to Toe~Skin/Body~Pressure Ulcer Details~Head to Toe' || key=='Residential~Skin/Body~Pressure Ulcer Detail~Residential'}"/>
        <c:EvaluationResponseTable parentId="{!$CurrentPage.parameters.evalId}" type="Pressure Ulcer Detail Log" showTitle="false" collapsible="false" formId="{!$Component.evalResponsesForm}" uniqueId="decubitiLog" rendered="{!key == 'Head to Toe~Skin/Body~Pressure Ulcer Details~Activity Log'}"/>
				<apex:pageBlockButtons location="bottom">
					<input class="btn" type="button" value="Close" onclick="clearPanel();" />
				</apex:pageBlockButtons>
			</apex:pageBlock>
		</apex:form>
	</apex:outputPanel>


	<apex:outputPanel id="dialog-confirm-navigation" title="Confirm save" layout="block">
		<apex:outputPanel layout="inline">
			<apex:outputPanel layout="inline" styleClass="ui-icon ui-icon-alert" style="float:left; margin:0 7px 10px 0;">
			</apex:outputPanel>
			Do you want to save before navigating away?
		</apex:outputPanel>
	</apex:outputPanel>


	<apex:actionStatus id="myStatus">
		<apex:facet name="start">
			<style>
				.thinkingwheel {
					position: fixed;
					left: 50%;
					top: 50%;
					background-color: white;
					border: 2px solid gray;
					padding: 2px;
					z-index: 2000;
				}

				.foggy {
					opacity: 0.8;
					background-color: #ccc;
					position: fixed;
					width: 100%;
					height: 100%;
					top: 0px;
					left: 0px;
					z-index: 1000;
				}
			</style>

			<div class="foggy" />
			<div class="thinkingwheel">
				<span><img class="waitingImage" src="/img/loading.gif" title="Please Wait..." /> Processing . . . </span>
			</div>
		</apex:facet>
		<apex:facet name="stop"> </apex:facet>
	</apex:actionStatus>
</apex:page>