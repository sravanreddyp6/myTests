<apex:page standardController="Contact" extensions="PBSedit_controller,PBS_controller_helper" standardStylesheets="true" sidebar="false" tabStyle="Persons_Being_Served_New__tab">
    <apex:includeScript value="{!URLFOR($Resource.jquery, 'js/jquery-1.7.2.min.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.CommonJS)}" />
    <apex:includeScript value="{!URLFOR($Resource.jquery, 'js/jquery-ui-1.8.21.custom.min.js')}" />
    <apex:stylesheet value="{!URLFOR($Resource.jquery, 'css/custom-theme/jquery-ui-1.8.21.custom.css')}" />
    <apex:variable value="{!$User.Operating_Group__c == 'CareMeridian' || $User.Operating_Group__c == 'Care Meridian'}" var="vfVarIsCM" />
     <apex:variable value="{!$User.Operating_Group__c == 'NeuroRestorative' || $User.Operating_Group__c == 'Neuro Restorative'}" var="isNR" />
    <apex:stylesheet value="{!URLFOR($Resource.mentoresd,'/mentoresd.css')}" />
    <style type="text/css">
        .nowrap {
            white-space: nowrap;
        }

        .fixed-dialog {
            position: fixed;
            top: 75px;
            left: 100px;
            overflow-y: scroll;
            max-height: 600px;
        }
    </style>



    <script language="javascript">
        function setFocusOnLoad() {}
        var inputsDisabled = []; // global variable to hold the list of inputs disabled unsing below script. These needs to be enabled before submit or else they dont get submitted.
        jQuery(document).ready(function($) {
            setUpFields = function() {
                $('body input').on("change", function(event) {
                    applyRulesToField(event.target);
                    applyShowHideRulesToField(event.target);
                });
                $('body select').on("change", function(event) {
                    applyRulesToField(event.target);
                    applyShowHideRulesToField(event.target);
                });
                $('body input').each(function(_, target) {
                    applyRulesToField(target);
                    applyShowHideRulesToField(target);
                });
                $('body select').each(function(_, target) {
                    applyRulesToField(target);
                    applyShowHideRulesToField(target);
                });
            }
            setUpFields();
            setUpTabOrder();

            // this is to remove the disabled property from
            $('form').bind('submit', function() {
                $.each(inputsDisabled, function(_, $inDis) {
                    $inDis.prop("disabled", false);
                })
            });

        }); //end "ready" function

        j$ = jQuery.noConflict();

        // a variable to hold the list of related Parties... need this so we can refresh it using ajax
        var relPartyData = '{!relPartiesJSON}';

        //PRI-PRI-162
        function setUpTabOrder(){
        	console.log('start tab order');
              j$('.setMailStateTab').focus(
                  function(){
                      j$('select[id$=MailingStateCode ]').attr("tabindex", 100);
                      console.log(j$(this).attr("tabindex"));
                  }
              );        
              j$('.setOtherStateTab').focus(
                  function(){
                      j$('select[id$=OtherStateCode ]').attr("tabindex", 120);
                      console.log(j$(this).attr("tabindex"));
                  }
              );             
              j$('.setFamMilInvBranchTab').focusout(
                  function(){
                      j$('select[id$=FamMilInvBranch ]').focus();
                      j$('select[id$=FamMilInvBranch ]').attr("tabindex", 310);
                      console.log(j$(this).attr("tabindex"));
                  }
              );                 
            var tabindex = 20000;
              j$('body :input').each(function() {
                 if (this.type != "hidden") {
                   var $input = j$(this);
                   if( $input.attr("tabindex") == ''){
                       $input.attr("tabindex", tabindex);
                       //console.log($input);
                   }
                 }
              });    
              tabindex = 1000;    
              j$('#theWholeForm :input').each(function() {
                 if (this.type != "hidden") {
                   var $input = j$(this);
                   if( $input.attr("tabindex") == 20000){
                       $input.attr("tabindex", tabindex);
                       //console.log($input);
    
                   }
                 }
              });  
              tabindex = 2000;    
              j$('.btn').each(function() {
                 if (this.type != "hidden") {
                   var $input = j$(this);
                       $input.attr("tabindex", tabindex);
                       //console.log($input);
    
                 }
              });     
              tabindex = 50;    
              j$('.fundingInfo').each(function() {
                 if (this.type != "hidden") {
                   var $input = j$(this);
                       $input.attr("tabindex", tabindex);
                       //console.log($input);
    
                 }
              });    
              j$('[id$=MailingStateCode] :input').each(function() {
                j$(this).change(
                    function(){
                      j$(this).attr("tabindex", 100);
                      console.log(j$(this).attr("tabindex"));                    
                    }
                );
              });        
              j$('select[id$=MailingStateCode ]').attr("tabindex", 100);
                  console.log(j$('select[id$=MailingStateCode ]').attr("tabindex"));
              j$('select[id$=OtherStateCode ]').attr("tabindex", 120);
              j$('select[id$=FamMilInvBranch ]').attr("tabindex", 310);
                   console.log('end tab order');    
        }
      
        
        //disable enter key
        function stopRKey(evt) {
            var evt = (evt) ? evt : ((event) ? event : null);
            var node = (evt.target) ? evt.target : ((evt.srcElement) ? evt.srcElement : null);
            if ((evt.keyCode == 13) && (node.type == "text")) {
                return false;
            }
        }

        //opens the dialog
        function openDialog(dialogId, tagType, titleString) {
            console.log('trying to open modal');
            selector = tagType + '[id$=' + dialogId + ']';

            j$(selector).dialog({
                dialogClass: 'fixed-dialog',
                title: titleString,
                modal: true,
                width: 800,
                closeOnEscape: false
            }).parent().appendTo(j$('form[id$=FormId]'));
            j$(selector).parent().find('a.ui-dialog-titlebar-close').remove();
        }

        function closeDialog(dialogId, tagType) {
            selector = tagType + '[id$=' + dialogId + ']';

            j$(selector).dialog('destroy');
        }
        function agencySave(isClose) {
            j$('#agencyErrors').html('');
            if (j$('input[id$=agencyEntry_Name]').val() != '') {
                j$('input[id$=agencyName]').val(j$('input[id$=agencyEntry_Name]').val());
                j$('input[id$=agencyPhone]').val(j$('input[id$=agencyEntry_Phone]').val());
                j$('input[id$=agencyAddress]').val(j$('textarea[id$=agencyEntry_Address]').val());
                j$('input[id$=agencyReason]').val(j$('textarea[id$=agencyEntry_Reason]').val());

                saveAgency();
                if (isClose) {
                    closeDialog('agencyModal', 'span');
                }
            } else {
                j$('#agencyErrors').html('<li>Name is required.</li>');
            }
        }
        function validateRelatedParty() {
            var errors = '';
            j$('#relatedPartyErrors').html(errors);
            if (j$('input[id$=relatedPartyEntry_Name]').val() == '') {
                errors += '<li>Party Name is a required field.</li>';
            }
            if (j$('select[id$=relatedPartyEntry_Status]').val() == '') {
                errors += '<li>Status is a required field.</li>';
            }            
            var partyType = j$('select[id$=relatedPartyEntry_Type]').val();
            if (partyType == '') {
                errors += '<li>Type is a required field.</li>';
            }
            var x = j$('input[id$=relatedPartyEntry_Email]').val();
            if (x.length > 0) {
                var atpos = x.indexOf("@");
                var dotpos = x.lastIndexOf(".");
                if (atpos < 1 || dotpos < atpos + 2 || dotpos + 2 >= x.length) {
                    errors += '<li>Email is not a valid Email address</li>';
                }
            }
            var partyID = j$('input[id$=relatedPartyEntry_Id]').val();
            str = "Physician - Primary";
            var obj = JSON.parse(relPartyData);

            var isPrimaryPhysician = false;
            for (var i = 0; i < obj.length; i++) {
                if (obj[i].TypeC === str) {
                    isPrimaryPhysician = true;
                    break;
                }
            }

            for (var i = 0; i < obj.length; i++) {
                if ((!partyID && isPrimaryPhysician && partyType === str) || // adding a new related party and one already exists thats primary physician .
                    (partyID === obj[i].Id && isPrimaryPhysician && obj[i].TypeC != str && partyType === str)) { // editing existing one and changing its type to primary physician but one already present.
                    errors += '<li>Only one "Physician - Primary" allowed. Please edit Type on this entry or change the Type assigned to existing Related Party.</li>';
                    break;
                }
            }
            j$('#relatedPartyErrors').html(errors);
            return (errors == '');
        }

        //copies relatedParty fields from dialog for postback
        function relatedPartySave(isDialogClose) {
            if (validateRelatedParty()) {
                var partyID = j$('input[id$=relatedPartyEntry_Id]').val();
                var partyName = j$('input[id$=relatedPartyEntry_Name]').val();
                var partyType = j$('select[id$=relatedPartyEntry_Type]').val();
                var partyEmail = j$('input[id$=relatedPartyEntry_Email]').val();
                var partyPhone1 = j$('input[id$=relatedPartyEntry_Phone]').val();
                var partyAddress = j$('textarea[id$=relatedPartyEntry_Address]').val();
                var partyPhone2 = j$('input[id$=relatedPartyEntry_Phone_2]').val();
                var partyPhone1Type = j$('select[id$=relatedPartyEntry_Phone_1_Type]').val();
                var partyPhone2Type = j$('select[id$=relatedPartyEntry_Phone_2_Type]').val();
                var partyComments = j$('textarea[id$=relatedPartyEntry_Comments]').val();
                var partyStatus = j$('select[id$=relatedPartyEntry_Status]').val();
                var pbsID = '{!Contact.Id}';
                PBS_controller_helper.saveRelatedParty(partyID, partyName, partyType, partyPhone1, partyEmail,
                    partyAddress, partyPhone2, partyPhone1Type, partyPhone2Type, partyComments, partyStatus, pbsID,
                    function(result, event) {
                        saveRelParty();
                        if (isDialogClose) {
                            closeDialog('relatedPartyModal', 'span');
                        }
                    }, {
                        escape: true
                    }
                );
            }
            return false;
        }

        function loadRelatedParty(partyId) {
            PBS_controller_helper.loadRelatedParty(partyId,
                function(result, event) {
                    if (event.status) {
                        j$('input[id$=relatedPartyEntry_Id]').val(result.Id);
                        j$('input[id$=relatedPartyEntry_Name]').val(result.Name);
                        j$('select[id$=relatedPartyEntry_Type]').val(result.Type__c);
                        j$('input[id$=relatedPartyEntry_Email]').val(result.Email__c);
                        j$('input[id$=relatedPartyEntry_Phone]').val(result.Phone__c);
                        j$('textarea[id$=relatedPartyEntry_Address]').val(result.Address__c);
                        j$('input[id$=relatedPartyEntry_Phone_2]').val(result.Phone_2__c);
                        j$('select[id$=relatedPartyEntry_Phone_1_Type]').val(result.Phone_1_Type__c);
                        j$('select[id$=relatedPartyEntry_Phone_2_Type]').val(result.Phone_2_Type__c);
                        j$('textarea[id$=relatedPartyEntry_Comments]').val(result.Comments__c);
                        j$('select[id$=relatedPartyEntry_Status]').val(result.Status__c);

                        openDialog('relatedPartyModal', 'span', 'Add Related Party');
                    }
                }, {
                    escape: true
                }
            );
        }
    </script>

    <c:PersonalRecord pbsId="{!PBSId}" parentPage="PBS" />
    <br />
    <div id="theWholeForm">
    <apex:form id="FormId">
        <apex:actionFunction name="saveRelParty" action="{!saveRelParty}" rerender="relatedParties,relatedPartyEntry,relatedPartyEntry2,msgs" />
        <apex:actionFunction name="showAddRelParty" action="{!showAddRelParty}" rerender="relatedParties,relatedPartyEntry,relatedPartyEntry2,msgs" />
        <!-- START: CTEAE-39; siblings -->
        <apex:actionFunction name="showAddSibling" action="{!showAddSibling}" rerender="siblings,msgs" />
        <!-- END: CTEAE-39; siblings -->
        <apex:pageMessages />

        <!--Person Being Served Section-->
        <apex:pageBlock id="PBSDetailID" title="Person Being Served">
            <div class="pbHeaderButton">
                <apex:commandButton value="Edit Person Being Served" action="{!showEditMode}" rendered="{! AND(NOT(pbsEditModeOn), isEditor)}" />
                <apex:commandButton value="Save" id="SavePBSId" action="{!save}" rendered="{!AND(pbsEditModeOn, isEditor)}" />
                <apex:commandButton value="Cancel" id="CancelPBSId" action="{!cancelPBSController}" rendered="{!AND(pbsEditModeOn, isEditor)}" />
            </div>
            <apex:pageBlockSection title="Demographics" showHeader="true" columns="2" collapsible="true" id="pbsOutPutsectionId">
                <apex:inputField value="{!Contact.FirstName}" taborderhint="1" rendered="{! pbsEditModeOn }" id="FirstNameInput" required="true"/>
                <apex:inputField value="{!Contact.Race__c }" taborderhint="2" rendered="{! pbsEditModeOn }"/>
                <apex:inputField value="{!Contact.Middle_Name__c}" taborderhint="1" rendered="{! pbsEditModeOn }"/>
                <apex:inputField value="{!Contact.Ethnicity_Picklist__c}" taborderhint="2" rendered="{! pbsEditModeOn }"/>
                <apex:inputField value="{!Contact.LastName}" taborderhint="1" rendered="{! pbsEditModeOn }"/>
                <apex:inputField value="{!Contact.Marital_Status__c}" taborderhint="2" rendered="{! pbsEditModeOn }"/>
                <apex:pageBlockSectionItem rendered="{! pbsEditModeOn }" >
                    <apex:outputLabel value="Date of Birth" for="txtDOB" />
                         <apex:outputPanel styleClass="requiredInput" layout="block" >
                            <apex:outputPanel styleClass="requiredBlock" layout="block" />
                            <apex:inputfield id="txtDOB" taborderhint="1" value="{!Contact.Birthdate}" label="Date of Birth" required="true" />
                        </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem rendered="{!  pbsEditModeOn }">
                    <apex:outputText value="Primary Language" />
                    <apex:outputPanel styleClass="nowrap">
                        <apex:inputField taborderhint="2" value="{!Contact.Primary_Language__c}" /> &nbsp;&nbsp;
                        <apex:outputLabel value="Non-Verbal" />&nbsp;
                        <apex:inputField taborderhint="2" value="{!Contact.Non_Verbal__c}"  />&nbsp;
                        <apex:outputLabel value="Sign Language" />&nbsp;
                        <apex:inputField taborderhint="2" value="{!Contact.Sign_Language__c}"  />
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                 <apex:outputText label="Age" value="{!Age}" rendered="{! pbsEditModeOn }"/>
<!--                  Sravan - Aug 20, 2015 - PRI-224 -->
<!--                 <apex:inputField value="{!Contact.Level_of_Education__c}" taborderhint="2" rendered="{! pbsEditModeOn }"/> -->
				<apex:pageBlockSectionItem rendered="{! pbsEditModeOn }" />
				<apex:inputField value="{!Contact.Gender__c}" taborderhint="1" required="true" rendered="{! pbsEditModeOn }" />
				<apex:pageBlockSectionItem rendered="{! pbsEditModeOn }" />
				<apex:inputField value="{!Contact.Does_the_person_Identify__c}" id="identifyOtherGender" label="Does the person Identify with a gender other than legal gender selected?" rendered="{! pbsEditModeOn }" html-data-visibility-rules="{&quot;Yes&quot;: [&quot;{!$Component.genderIdentity}&quot;, &quot;{!$Component.genderIdentityLabel}&quot;]}"
					html-data-visibility-row-rules="true"/>
				<apex:pageBlockSectionItem rendered="{! pbsEditModeOn }"/>
				<apex:inputField value="{!Contact.Gender_Identity__c}" id="genderIdentity"  rendered="{! pbsEditModeOn }"/>

                
                <!--  view -->
                <apex:outputField value="{!Contact.FirstName}"  rendered="{! !pbsEditModeOn }"/>
                <apex:outputField value="{!Contact.Race__c }" rendered="{! !pbsEditModeOn }"/>
                <apex:outputField value="{!Contact.Middle_Name__c}" rendered="{! !pbsEditModeOn }"/>
                <apex:outputField value="{!Contact.Ethnicity_Picklist__c}" rendered="{! !pbsEditModeOn }"/>
                <apex:outputField value="{!Contact.LastName}" rendered="{! !pbsEditModeOn }"/>
                <apex:outputField value="{!Contact.Marital_Status__c}" rendered="{! !pbsEditModeOn }"/>
                <apex:pageBlockSectionItem rendered="{! NOT(pbsEditModeOn)}" >
                        <apex:outputLabel value="Date of Birth" for="txtDOB" />
                          <apex:outputPanel layout="block" >
                           <apex:outputPanel layout="block" />
                             <apex:outputField id="txtDOB"  value="{!Contact.Birthdate}"/>
                             </apex:outputPanel>
                    </apex:pageBlockSectionItem>
                <apex:pageBlockSectionItem rendered="{!NOT(pbsEditModeOn) }">
                
                    <apex:outputText value="Primary Language" />
                    <apex:outputPanel styleClass="nowrap">
                        <apex:outputField value="{!Contact.Primary_Language__c}" /> &nbsp;&nbsp;
                        <apex:outputLabel value="Non-Verbal" />&nbsp;
                        <apex:outputField value="{!Contact.Non_Verbal__c}"  />&nbsp;
                        <apex:outputLabel value="Sign Language" />&nbsp;
                        <apex:outputField value="{!Contact.Sign_Language__c}"  />
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>    
                
                <apex:outputText label="Age" value="{!Age}" rendered="{! !pbsEditModeOn }"/>
<!--                 <apex:outputField value="{!Contact.Level_of_Education__c}" rendered="{! !pbsEditModeOn }"/> -->
				<apex:pageBlockSectionItem rendered="{! !pbsEditModeOn }" />
                <apex:outputField value="{!Contact.Gender__c}" rendered="{! !pbsEditModeOn }"/>
                <apex:pageBlockSectionItem />
                <apex:pageBlockSectionItem rendered="{!!pbsEditModeOn}" >
			 		<apex:outputLabel value="Does the person Identify with a gender other than legal gender selected?" />
	   				<apex:outputField value="{!Contact.Does_the_person_Identify__c}" />
		   		</apex:pageBlockSectionItem>
		   		<apex:pageBlockSectionItem />
		   		<apex:pageBlockSectionItem rendered="{!!pbsEditModeOn && Contact.Does_the_person_Identify__c == 'Yes'}" >
		   			<apex:outputLabel value="Describe Gender Identity"  />			   		
		   			<apex:outputField value="{!Contact.Gender_Identity__c}" />
		   		</apex:pageBlockSectionItem>
		   		
            </apex:pageBlockSection>

            <apex:pageBlockSection title="Funding Information" showHeader="true" columns="2" collapsible="true" id="pbsOutputFundingSection" rendered="{! pbsEditModeOn}">
				<apex:inputField taborderhint="5" value="{!contact.Medicaid_ID__c }" />
				<apex:inputField taborderhint="6" value="{!contact.Other_ID__c }" />
				<apex:inputField taborderhint="5" value="{!contact.Avatar_ID__c }" />
				<apex:inputField taborderhint="6" value="{!contact.Other_ID_Description__c }" />
				<apex:inputField taborderhint="5" value="{!contact.Avatar_Source_System__c }" />
				<apex:inputField taborderhint="6" value="{!contact.UCI_ID__c }" rendered="{! Contact.MailingStateCode == 'CA'}"/>
            </apex:pageBlockSection>
            <apex:pageBlockSection title="Funding Information" showHeader="true" columns="2" collapsible="true" id="pbsOutputFundingSection_view" rendered="{! !pbsEditModeOn}">
				<apex:outputField value="{!contact.Medicaid_ID__c }" />
				<apex:outputField value="{!contact.Other_ID__c }" />
				<apex:outputField value="{!contact.Avatar_ID__c }" />
				<apex:outputField value="{!contact.Other_ID_Description__c }" />
				<apex:outputField value="{!contact.Avatar_Source_System__c }" />
				<apex:outputField value="{!contact.UCI_ID__c }" rendered="{! Contact.MailingStateCode == 'CA'}"/>
            </apex:pageBlockSection>            

            <!--Contact Information Section-->
            <apex:pageBlockSection title="Contact Information" showHeader="true" columns="2" collapsible="true" id="pbsOutputContactInfo">


				<apex:pageBlockSectionItem rendered="{!  pbsEditModeOn }" >
				    <apex:outputLabel value="Mailing Street 1" for="Ma" />
				    <apex:inputText tabindex="100" id="ma"  value="{!contact.MailingStreet}" label="Mailing Street 1" />
				</apex:pageBlockSectionItem>
				<apex:pageBlockSectionItem rendered="{!  pbsEditModeOn}" >
				    <apex:outputLabel value="Other Street 1" for="os" />
				    <apex:inputText tabindex="120" id="os"  value="{!contact.OtherStreet}" label="Other Street 1" />
				</apex:pageBlockSectionItem>
				<apex:inputField taborderhint="10" value="{!contact.Mailing_Street_2__c}" rendered="{!  pbsEditModeOn}"/>
				<apex:inputField taborderhint="12" value="{!contact.Other_Street_2__c}" rendered="{!  pbsEditModeOn}"/>
				<apex:inputField taborderhint="10" value="{!contact.MailingCity}" rendered="{!  pbsEditModeOn}"/>
				<apex:inputField taborderhint="12" value="{!contact.OtherCity}" rendered="{!  pbsEditModeOn}"/>
				<apex:pageBlockSectionItem rendered="{!  pbsEditModeOn}" >
				    <apex:outputLabel value="Mailing Country" for="os" />
				    <apex:inputField taborderhint="10" styleClass="setMailStateTab" value="{!contact.MailingCountryCode}" label="Mailing Country" />
				</apex:pageBlockSectionItem>
				<apex:pageBlockSectionItem rendered="{!  pbsEditModeOn}" >
				    <apex:outputLabel value="Other Country" for="os" />
				    <apex:inputField taborderhint="12" styleclass="setOtherStateTab"  value="{!contact.OtherCountryCode}" label="Other Country" />
				</apex:pageBlockSectionItem>
				
				<apex:pageBlockSectionItem rendered="{!  pbsEditModeOn}" >
				    <apex:outputLabel value="Mailing State/Province" for="os" />
				    <apex:outputPanel >
				        <apex:inputField id="MailingStateCode" taborderhint="10" html-class="testingTabs"  value="{!contact.MailingStateCode}" label="Mailing State/Province" />
				    </apex:outputPanel>
				</apex:pageBlockSectionItem>
				
				    
				
				<apex:pageBlockSectionItem rendered="{!  pbsEditModeOn}" >
				    <apex:outputLabel value="Other State/Province" for="os" />
				    <apex:inputField taborderhint="12"  id="OtherStateCode"  value="{!contact.OtherStateCode}" label="Other State/Province" />
				</apex:pageBlockSectionItem>
				<apex:inputField taborderhint="10" value="{!contact.MailingPostalCode}"  styleClass="setMailStateTab"  rendered="{!  pbsEditModeOn}"/>
				<apex:inputField taborderhint="12" styleclass="setOtherStateTab"     value="{!contact.OtherPostalCode}"   rendered="{!  pbsEditModeOn}"/>
				<apex:inputField taborderhint="10" value="{!contact.Mailing_County__c}"  rendered="{!  pbsEditModeOn}" />
				<apex:inputField taborderhint="12" value="{!contact.Other_County__c}"  rendered="{!  pbsEditModeOn}" />
				<apex:pageBlockSectionItem rendered="{!  pbsEditModeOn}" >
				    <apex:outputLabel value="Phone" for="os" />
				    <apex:inputField taborderhint="10" value="{!contact.HomePhone}" label="Other Country" />
				</apex:pageBlockSectionItem>
				<apex:inputField taborderhint="12" value="{!contact.OtherPhone}"  rendered="{!  pbsEditModeOn}" />
				<apex:inputField taborderhint="10" value="{!contact.Email}"  rendered="{!  pbsEditModeOn}" />
				<apex:inputField taborderhint="12" value="{!contact.Other_Contact_Information__c}"  rendered="{!  pbsEditModeOn}"  />
				
				<!-- view -->
				<apex:pageBlockSectionItem rendered="{!  !pbsEditModeOn }" >
				    <apex:outputLabel value="Mailing Street 1" for="Ma" />
				    <apex:outputField id="ma"  value="{!contact.MailingStreet}" label="Mailing Street 1" />
				</apex:pageBlockSectionItem>
				<apex:pageBlockSectionItem rendered="{!  !pbsEditModeOn}" >
				    <apex:outputLabel value="Other Street 1" for="os" />
				    <apex:outputField id="os"  value="{!contact.OtherStreet}" label="Other Street 1" />
				</apex:pageBlockSectionItem>
				<apex:outputField value="{!contact.Mailing_Street_2__c}" rendered="{!  !pbsEditModeOn}"/>
				<apex:outputField value="{!contact.Other_Street_2__c}" rendered="{!  !pbsEditModeOn}"/>
				<apex:outputField value="{!contact.MailingCity}" rendered="{!  !pbsEditModeOn}"/>
				<apex:outputField value="{!contact.OtherCity}" rendered="{!  !pbsEditModeOn}"/>
				<apex:pageBlockSectionItem rendered="{!  !pbsEditModeOn}" >
				    <apex:outputLabel value="Mailing Country" for="os" />
				    <apex:outputField styleClass="setMailStateTab" value="{!contact.MailingCountryCode}" label="Mailing Country" />
				</apex:pageBlockSectionItem>
				<apex:pageBlockSectionItem rendered="{!  !pbsEditModeOn}" >
				    <apex:outputLabel value="Other Country" for="os" />
				    <apex:outputField styleclass="setOtherStateTab"  value="{!contact.OtherCountryCode}" label="Other Country" />
				</apex:pageBlockSectionItem>
				
				<apex:pageBlockSectionItem rendered="{!  !pbsEditModeOn}" >
				    <apex:outputLabel value="Mailing State/Province" for="os" />
				    <apex:outputPanel >
				        <apex:outputField id="MailingStateCode"  html-class="testingTabs"  value="{!contact.MailingStateCode}" label="Mailing State/Province" />
				    </apex:outputPanel>
				</apex:pageBlockSectionItem>
				
				    
				
				<apex:pageBlockSectionItem rendered="{!  !pbsEditModeOn}" >
				    <apex:outputLabel value="Other State/Province" for="os" />
				    <apex:outputField id="OtherStateCode"  value="{!contact.OtherStateCode}" label="Other State/Province" />
				</apex:pageBlockSectionItem>
				<apex:outputField value="{!contact.MailingPostalCode}"  styleClass="setMailStateTab"  rendered="{!  !pbsEditModeOn}"/>
				<apex:outputField styleclass="setOtherStateTab"     value="{!contact.OtherPostalCode}"   rendered="{!  !pbsEditModeOn}"/>
				<apex:outputField value="{!contact.Mailing_County__c}"  rendered="{!  !pbsEditModeOn}" />
				<apex:outputField value="{!contact.Other_County__c}"  rendered="{!  !pbsEditModeOn}" />
				<apex:pageBlockSectionItem rendered="{!  !pbsEditModeOn}" >
				    <apex:outputLabel value="Phone" for="os" />
				    <apex:outputField value="{!contact.HomePhone}" label="Other Country" />
				</apex:pageBlockSectionItem>
				<apex:outputField value="{!contact.OtherPhone}"  rendered="{!  !pbsEditModeOn}" />
				<apex:outputField value="{!contact.Email}"  rendered="{!  !pbsEditModeOn}" />
				<apex:outputField value="{!contact.Other_Contact_Information__c}"  rendered="{!  !pbsEditModeOn}"  />
            </apex:pageBlockSection>

            <apex:pageBlockSection title="Financial Information" showHeader="true" columns="2" collapsible="true" id="pbsOutputFinancialInfo"  rendered="{!showDiagnosis && !isUserLevel1or2 && !canViewFamilyInfo && pbsEditModeOn && !isNR}">
                <apex:inputField taborderhint="15" value="{!contact.SSI__c}"  />
                <apex:inputField taborderhint="16" value="{!contact.RSDI__c}"  />
                <apex:inputField taborderhint="15" value="{!contact.FinancialMCD__c}"  />
                <apex:inputField taborderhint="16" value="{!contact.Checking_Account_Location__c}"  />
                <apex:inputField taborderhint="15" value="{!contact.FinancialSS__c}"  />
                <apex:inputField taborderhint="16" value="{!contact.Savings_Account_location__c}"  />
                <apex:inputField taborderhint="15" value="{!contact.FundingMechanism__c}"  />
                <apex:inputField taborderhint="16" value="{!contact.Prepaid_burial_information__c}"  />
                <apex:inputField taborderhint="15" value="{!contact.Life_Insurance_Information__c}"  />
            </apex:pageBlockSection>
            <apex:pageBlockSection title="Financial Information" showHeader="true" columns="2" collapsible="true" id="pbsOutputFinancialInfo_view"   rendered="{! showDiagnosis && !isUserLevel1or2 && !canViewFamilyInfo &&  !pbsEditModeOn && !isNR}">
                <apex:outputField value="{!contact.SSI__c}"  />
                <apex:outputField value="{!contact.RSDI__c}"  />
                <apex:outputField value="{!contact.FinancialMCD__c}"  />
                <apex:outputField value="{!contact.Checking_Account_Location__c}"  />
                <apex:outputField value="{!contact.FinancialSS__c}"  />
                <apex:outputField value="{!contact.Savings_Account_location__c}"  />
                <apex:outputField value="{!contact.FundingMechanism__c}"  />
                <apex:outputField value="{!contact.Prepaid_burial_information__c}"  />
                <apex:outputField value="{!contact.Life_Insurance_Information__c}"  />
            </apex:pageBlockSection>            


            <!--Additional Information Section-->

            <a name="AI" id="AI" />
            <apex:pageBlockSection columns="2" title="Additional Information" showHeader="true" collapsible="False" id="pbsOutputAdditionalInfo" rendered="{! pbsEditModeOn}">

				<apex:inputField taborderhint="20" value="{!Contact.Family_Member_Other__c}" />
<!-- 				<apex:inputField taborderhint="21" value="{!Contact.Legal_Guardianship_Status__c}" /> -->
<!-- 				Added by Sravan for PRI-164 05/13/2015 -->
				<apex:pageBlocksectionitem >
					<apex:outputPanel >
                		<apex:outputLabel value="Guardianship Type" id="guardianshipTypeLabel"/>
                		<br/>
                		<br/>
                		<apex:outputLabel value="Partial Guardianship/Conservatorship" id="partialGuardianShipLabel"/>
                		<br/>
                		<br/>
                		<apex:outputLabel value="Legal/Guardianship Staus" rendered="{!Contact.Legal_Guardianship_Status__c != null}" />
                	</apex:outputPanel>
                	<apex:outputPanel >
                		<apex:inputField value="{!Contact.Guardianship_Type__c}" id="guardianShipType"  html-data-visibility-rules="{&quot;Partial Guardianship/Conservatorship&quot;: [&quot;{!$Component.partialGuardianShip}&quot;, &quot;{!$Component.partialGuardianShipLabel}&quot;]}"/>
                		<br/>
                		<br/>
                		<apex:inputField value="{!Contact.Partial_Guardianship_Conservatorship__c}" id="partialGuardianShip" />
                		<br/>
                		<br/>
                		<apex:outputField value="{!Contact.Legal_Guardianship_Status__c}" rendered="{!Contact.Legal_Guardianship_Status__c != null}" />
                	</apex:outputPanel>
                </apex:pageBlocksectionitem>
			
				<apex:inputField taborderhint="20" value="{!Contact.VIP_Indicator__c}" />
				<apex:inputField taborderhint="21" value="{!Contact.Current_Medications__c}" rendered="{! !Contains(dontShowFields, 'Current_Medications__c')}" />
				<apex:pageBlockSectionItem rendered="{! !Contains(dontShowFields, 'Current_Medications__c')}" /> 
				
                <apex:pageBlockSectionItem rendered="{! !Contains(dontShowFields, 'Advanced_Directives__c')}" />                
                <apex:inputField taborderhint="20" value="{!Contact.Advanced_Directives__c}" rendered="{! !Contains(dontShowFields, 'Advanced_Directives__c')}" html-data-rules="{&quot;1&quot;: &quot;{!$Component.advanceAttached}&quot;}" />                
                <apex:inputField taborderhint="21" value="{!Contact.Code_Status__c}" html-data-rules="{&quot;Other&quot;: &quot;{!$Component.codeStatusOther}&quot;}" rendered="{! !Contains(dontShowFields, 'Code_Status__c')}" />                
                
                <apex:inputField taborderhint="20" value="{!Contact.Advanced_Directives_Attached__c}" rendered="{!  !Contains(dontShowFields, 'Advanced_Directives_Attached__c')}" id="advanceAttached" />                
                <apex:inputField taborderhint="21" value="{!Contact.Code_Status_Other__c}" id="codeStatusOther" label="Specify Other" rendered="{! !Contains(dontShowFields, 'Code_Status_Other__c')}" />

			</apex:pageBlockSection>
            <apex:pageBlockSection columns="2" title="Additional Information" showHeader="true" collapsible="False" id="pbsOutputAdditionalInfo_view" rendered="{! !pbsEditModeOn}">
				<apex:outputField value="{!Contact.Family_Member_Other__c}" />
				<apex:pageBlocksectionitem >
					<apex:outputPanel >
                		<apex:outputLabel value="Guardianship Type" id="guardianshipTypeLabel"/>
                		<br/>
                		<br/>
                		<apex:outputLabel value="Partial Guardianship/Conservatorship" id="partialGuardianShipLabel"/>
                		<br/>
                		<br/>
                		<apex:outputLabel value="Legal/Guardianship Staus" rendered="{!Contact.Legal_Guardianship_Status__c != null}" />
                	</apex:outputPanel>
                	<apex:outputPanel >
                		<apex:outputField value="{!Contact.Guardianship_Type__c}" id="guardianShipType"  html-data-visibility-rules="{&quot;Partial Guardianship/Conservatorship&quot;: [&quot;{!$Component.partialGuardianShip}&quot;, &quot;{!$Component.partialGuardianShipLabel}&quot;]}"/>
                		<br/>
                		<br/>
                		<apex:outputField value="{!Contact.Partial_Guardianship_Conservatorship__c}" id="partialGuardianShip" />
                		<br/>
                		<br/>
                		<apex:outputField value="{!Contact.Legal_Guardianship_Status__c}" rendered="{!Contact.Legal_Guardianship_Status__c != null}" />
                	</apex:outputPanel>
                </apex:pageBlocksectionitem>
                <apex:outputField value="{!Contact.VIP_Indicator__c}" />
				<apex:outputField value="{!Contact.Current_Medications__c}" rendered="{! !Contains(dontShowFields, 'Current_Medications__c')}" />
				<apex:pageBlockSectionItem rendered="{! !Contains(dontShowFields, 'Current_Medications__c')}" /> 
				
                <apex:pageBlockSectionItem rendered="{! !Contains(dontShowFields, 'Advanced_Directives__c')}" />                
                <apex:outputField value="{!Contact.Advanced_Directives__c}" rendered="{! !Contains(dontShowFields, 'Advanced_Directives__c')}" html-data-rules="{&quot;1&quot;: &quot;{!$Component.advanceAttached}&quot;}" />                
                <apex:inputField value="{!Contact.Code_Status__c}" html-data-rules="{&quot;Other&quot;: &quot;{!$Component.codeStatusOther}&quot;}" rendered="{! !Contains(dontShowFields, 'Code_Status__c')}" />                
                
                <apex:outputField value="{!Contact.Advanced_Directives_Attached__c}" rendered="{!  !Contains(dontShowFields, 'Advanced_Directives_Attached__c')}" id="advanceAttached" />                
                <apex:outputField value="{!Contact.Code_Status_Other__c}" id="codeStatusOther" label="Specify Other" rendered="{! !Contains(dontShowFields, 'Code_Status_Other__c')}" />
			</apex:pageBlockSection>	
					
            <apex:pageBlockSection columns="2" collapsible="False" id="pbsOutputRecordInfo">
				<apex:pageBlockSectionItem />    
				<apex:pageBlockSectionItem />    
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Created By" />
                    <apex:outputPanel layout="none">
                        <apex:outputField value="{!Contact.CreatedById}" />,&nbsp;
                        <apex:outputText value=" {!Contact.CreatedDate}" />
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>

                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Last Modified By" />
                    <apex:outputPanel layout="none">
                        <apex:outputField value="{!Contact.LastModifiedById}" />,&nbsp;
                        <apex:outputText value=" {!Contact.LastModifiedDate}" />
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>

                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Owner" />
                    <apex:outputPanel layout="none">
                        <apex:outputField value="{!Contact.OwnerId}" rendered="{!NOT(pbsEditModeOn)}" />
                        <apex:inputField taborderhint="20" value="{!Contact.OwnerId}" rendered="{!pbsEditModeOn}" />
                        <i>{!IF( !pbsEditModeOn,'to change, click on Edit Person Being Served','')}</i>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>

            </apex:pageBlockSection>
            <!-- rearranged this section information for  EPRIQM-107  -->
                       <!--Family Information Section-->
            <apex:pageBlockSection columns="2"  title="Family Information" showHeader="true" collapsible="True" id="pbsOutputFamilyInfo" rendered="{!canViewFamilyInfo}">
                 <apex:inputfield taborderhint="30" value="{!Contact.Family_Annual_Income__c}" rendered="{!pbsEditModeOn}" />
                 <apex:outputfield value="{!Contact.Family_Annual_Income__c}" rendered="{!!pbsEditModeOn}" />
                <apex:inputfield taborderhint="31" styleClass="setFamMilInvBranchTab" value="{!Contact.Family_Military_Involvement__c}" rendered="{!pbsEditModeOn}" />
                <apex:outputfield value="{!Contact.Family_Military_Involvement__c}" rendered="{!!pbsEditModeOn}" />
                 <apex:pageBlockSectionItem rendered="{!pbsEditModeOn}">
                    <apex:outputLabel for="nativeancestry" value="Family Native American Ancestry" />
                    <apex:actionRegion >
                        <apex:inputField id="nativeancestry"  taborderhint="30" value="{!Contact.Family_Native_American_Ancestry__c}">
                            <apex:actionStatus id="statusnativeancestry">
                                <apex:facet name="start">
                                    <div class="waitingHolder" style="display: inline; margin-left: 5px; position: relative; top: 5px;">
                                        <img class="waitingImage" src="/img/loading.gif" title="Please Wait..." /> <span class="waitingDescription"></span>
                                    </div>
                                </apex:facet>
                                <apex:facet name="stop"></apex:facet>
                            </apex:actionStatus>
                            <apex:actionSupport event="onchange" rerender="familynativeamericantribe" status="statusnativeancestry" oncomplete="setUpTabOrder();"/>
                        </apex:inputField>
                    </apex:actionRegion>
                </apex:pageBlockSectionItem>
                <apex:outputfield value="{!Contact.Family_Native_American_Ancestry__c}" rendered="{!!pbsEditModeOn}" />
                
                <apex:inputfield taborderhint="31" id="FamMilInvBranch" value="{!Contact.Family_Military_Involvement_Branch__c}" rendered="{!pbsEditModeOn}" />
                <apex:outputfield value="{!Contact.Family_Military_Involvement_Branch__c}" rendered="{!!pbsEditModeOn && Contact.Family_Military_Involvement__c != 'None'}" />
                
                 <apex:PageBlockSectionitem rendered="{!pbsEditModeOn}" >
                    <apex:outputLabel Value="Family Native American Tribe" for="nativetribe" />
                    <apex:outputpanel id="familynativeamericantribe" >
                        <apex:inputfield taborderhint="30" value="{!Contact.Family_Native_American_Tribe__c}" rendered="{!pbsEditModeOn && NOT(Contact.Family_Native_American_Ancestry__c)}" html-disabled="true" />
                        <apex:inputfield taborderhint="30" value="{!Contact.Family_Native_American_Tribe__c}" required="{!Contact.Family_Native_American_Ancestry__c}" rendered="{!pbsEditModeOn && Contact.Family_Native_American_Ancestry__c}" />
                    </apex:outputpanel>
                </apex:PageBlockSectionitem>
                   <apex:outputfield value="{!Contact.Family_Native_American_Tribe__c}" rendered="{!!pbsEditModeOn && Contact.Family_Native_American_Ancestry__c}" />
                <apex:inputfield taborderhint="31" value="{!Contact.Family_Prior_Military_Involvement_Date__c}" rendered="{!pbsEditModeOn}" />
                <apex:outputfield value="{!Contact.Family_Prior_Military_Involvement_Date__c}" rendered="{!!pbsEditModeOn && Contact.Family_Military_Involvement__c = 'Prior'}" />
            </apex:pageBlockSection>

        </apex:pageBlock>
        <!--Related Parties Section-->
        <a name="RP" id="RP"></a>

        <apex:pageBlock id="relatedPartiesListId">
            <div class="pbSubHeadButton">
                <apex:commandButton onclick="window.open('/{!RelatedPartyReport}?pv0={!Contact.Name}', '_self'); return false;" value="Related Parties Report" />
                <apex:commandButton value="Add Related Party" onClick="showAddRelParty();openDialog('relatedPartyModal', 'span', 'Add Related Party'); return false;" rendered="{!AND(isEditor, canEdit)}" />
            </div>
            <apex:pageBlockSection columns="1" title="Related Parties" id="relatedParties" collapsible="false">
                <apex:pageBlockSectionItem >

                </apex:pageBlockSectionItem>

                <apex:pageBlockTable value="{!relParties}" var="relParty">
                    <apex:column headerValue="Action">
                        <apex:outputPanel rendered="{!$ObjectType.Related_Party__c.updateable}"> <a href="#" onclick="loadRelatedParty('{!relParty.Id}');return false; ">Edit</a>
                        </apex:outputPanel>
                    </apex:column>	
                    <apex:column value="{!relParty.Type__c}" />
                    <apex:column value="{!relParty.Name}" />
                    <apex:column value="{!relParty.Address__c}" />
                    <apex:column value="{!relParty.Email__c}" />
                    <apex:column value="{!relParty.Phone__c}" />
                    <apex:column value="{!relParty.Phone_1_Type__c}" />
                    <apex:column value="{!relParty.Phone_2__c}" />
                    <apex:column value="{!relParty.Phone_2_Type__c}" />
                    <apex:column value="{!relParty.Status__c}" />
                    <apex:column value="{!relParty.Comments__c}" />
                    <apex:column value="{!relParty.CreatedDate}" />
                </apex:pageBlockTable>
                <script type="text/javascript">
                    relPartyData = '{!relPartiesJSON}';
                </script>
            </apex:pageBlockSection>
        </apex:pageBlock>

        <!-- Add Related Party modal. -->
        <apex:outputPanel id="relatedPartyModal" style="display:none; dispaly: block; height: 500px;">

            <apex:pageBlock title="Add Related Party">
                <apex:pageblockButtons location="bottom">
                    <input type="button" value="Save" onClick="relatedPartySave(true); " class="btn" />
                    <input type="button" value="Save & New" onClick="relatedPartySave(false);" class="btn" />
                    <input type="button" value="Cancel" onClick="closeDialog('relatedPartyModal', 'span'); j$('#relatedPartyErrors').html('');return false;" class="btn" />
                </apex:pageblockButtons>
                <apex:facet name="header">
                    <p><strong>Add a related party below:</strong>
                    </p>
                </apex:facet>
                <div id="relatedPartyErrors" style="color:red" />
                <apex:pageBlockSection columns="2" id="relatedPartyEntry">
                    <apex:inputField value="{!relParty.Name}" id="relatedPartyEntry_Name" />
                    <apex:inputField value="{!relParty.Type__c}" id="relatedPartyEntry_Type" />

                    <apex:inputField value="{!relParty.Address__c}" id="relatedPartyEntry_Address" />
                    <apex:inputField value="{!relParty.Email__c}" id="relatedPartyEntry_Email" />

                    <apex:inputField value="{!relParty.Phone__c}" id="relatedPartyEntry_Phone" />
                    <apex:inputField value="{!relParty.Phone_1_Type__c}" id="relatedPartyEntry_Phone_1_Type" />

                    <apex:inputField value="{!relParty.Phone_2__c}" id="relatedPartyEntry_Phone_2" />
                    <apex:inputField value="{!relParty.Phone_2_Type__c}" id="relatedPartyEntry_Phone_2_Type" />
                </apex:pageBlockSection>
                <apex:pageBlockSection columns="1" id="relatedPartyEntry2">
                    <apex:inputField value="{!relParty.Comments__c}" style="width: 90%;" id="relatedPartyEntry_Comments" />
                    <apex:inputField value="{!relParty.Status__c}" id="relatedPartyEntry_Status" />
                    <apex:outputPanel style="display:none">
                        <apex:inputHidden value="{!relParty.Id}" id="relatedPartyEntry_Id" />
                    </apex:outputPanel>
                </apex:pageBlockSection>
            </apex:pageBlock>
        </apex:outputPanel>

        <!--Agencies Related to Person Section-->
        <a name="Agency" id="Agency"></a>
        <apex:pageBlock id="relatedAgenciesId" rendered="{!showDiagnosis}">
                <div style="float: right;">
                    <apex:actionRegion >
                        <apex:actionFunction name="showAddAgency" action="{!showAddAgency}" rerender="agencies,agencyEntry,msgs" />
                    </apex:actionRegion>        
                    <apex:commandButton rendered="{!AND(isEditor, canEdit)}" value="Add Agency Involved With Individual" id="addAgency" onclick="showAddAgency(); openDialog('agencyModal', 'span', 'Add Agency','none'); return false;" />
  
                </div>                 
            <apex:pageBlockSection columns="1" title="Agencies Involved With Individual" id="relatedAgencies" collapsible="false">
                <apex:pageBlockSectionItem >
                </apex:pageBlockSectionItem>
                <apex:pageBlockTable value="{!relAgencies}" var="relAgency">
                    <apex:column headerValue="Action">
                        <apex:commandLink action="{!loadAgency}" reRender="agencyModal" oncomplete="openDialog('agencyModal', 'span', 'Add Agency','none'); return false;">
                        Edit
                            <apex:param assignTo="{!loadThisAgency}" value="{!relAgency.id}" name="loadThisAgency"  />
                        </apex:commandLink>

                    </apex:column>
                    <apex:column value="{!relAgency.Name}" />
                    <apex:column value="{!relAgency.Address__c}" />
                    <apex:column value="{!relAgency.Phone__c}" />
                    <apex:column value="{!relAgency.Reason_for_Involvement__c}" />
                    <apex:column value="{!relAgency.CreatedDate}" />
                </apex:pageBlockTable>
            </apex:pageBlockSection>
        </apex:pageBlock>
        <!-- Add Agency modal. -->
        <apex:actionRegion >
            <apex:outputPanel id="agencyModal" style="display:none">

                <apex:actionFunction name="saveAgency" action="{!saveAgency}" status="myStatus" rerender="relatedAgenciesId,agencyEntry,msgs" />

                <apex:pageBlock title="Add Agency Involved with Individual">
                    <apex:pageblockButtons location="bottom">
                        <apex:commandButton value="Save" onclick="agencySave(true); return false;" />
                        <apex:commandButton value="Save & New" onclick="agencySave(false); return false;" />
                        <apex:commandButton value="Cancel" onclick="closeDialog('agencyModal', 'span'); j$('#agencyErrors').html('');return false;" />
                    </apex:pageblockButtons>

                    <apex:facet name="header">
                        <p>
                            <strong>Add an agency involved with the person being referred below:</strong>
                        </p>
                    </apex:facet>

                    <div id='agencyErrors' style='color:red'></div>

                    <apex:pageBlockSection columns="1" id="agencyEntry">
                        <apex:pageBlockSectionItem >
                            <apex:outputLabel value="Agency Name:" />
                            <apex:inputText value="{!agency.Name}" id="agencyEntry_Name" />
                        </apex:pageBlockSectionItem>

                        <apex:pageBlockSectionItem >
                            <apex:outputLabel value="Address:" />
                            <apex:inputTextarea value="{!agency.Address__c}" id="agencyEntry_Address" />
                        </apex:pageBlockSectionItem>

                        <apex:pageBlockSectionItem >
                            <apex:outputLabel value="Phone Number:" />
                            <apex:inputField value="{!agency.Phone__c}" id="agencyEntry_Phone" />
                        </apex:pageBlockSectionItem>

                        <apex:pageBlockSectionItem >
                            <apex:outputLabel value="Reason for Involvement:" />
                            <apex:inputTextarea value="{!agency.Reason_for_Involvement__c}" id="agencyEntry_Reason" />
                        </apex:pageBlockSectionItem>
                    </apex:pageBlockSection>
                </apex:pageBlock>
            </apex:outputPanel>
        </apex:actionRegion>

        <apex:outputpanel style="display:none">
            <apex:inputHidden value="{!agency.Name}" id="agencyName" />
            <apex:inputHidden value="{!agency.Address__c}" id="agencyAddress" />
            <apex:inputHidden value="{!agency.Phone__c}" id="agencyPhone" />
            <apex:inputHidden value="{!agency.Reason_for_Involvement__c}" id="agencyReason" />
        </apex:outputpanel>         
        <!--Diagnosis Section -->
        <a name="Diag" id="Diag" />
        <apex:pageBlock id="Diagnosis" rendered="{!showDiagnosis && contact.MailingState != 'Arizona'}">
            <apex:pageBlockSection title="Diagnosis" showHeader="true" columns="1" collapsible="false">
                <apex:pageblockTable value="{!diagnosis}" var="diag" rendered="{!(diagnosis.size>0)}">
                    <apex:column headerValue="Effective Date" value="{!diag.Effective_Date__c}" />
                    <apex:column headerValue="Service Assignment"><a href="/{!diag.Service_Assignment__c}">{!diag.Service_Assignment__r.Name}</a>
                    </apex:column>
                    <apex:column value="{!diag.Primary_Diagnosis__c}" headerValue="Primary" />
                    <apex:column value="{!diag.Secondary_Diagnosis__c}" headerValue="Secondary" />
                    <apex:column value="{!diag.Axis_I__c}" headerValue="Axis I" />
                    <apex:column value="{!diag.Axis_II__c}" headerValue="Axis II" />
                    <apex:column value="{!diag.Axis_III__c}" headerValue="Axis III" />
                    <apex:column value="{!diag.Axis_IV__c}" headerValue="Axis IV" />
                    <apex:column value="{!diag.Axis_V__c}" headerValue="Axis V" />
                    <apex:column value="{!diag.Comments__c}" headerValue="Comments" />
                </apex:pageblockTable>
                <apex:outputText value="No diagnoses to display" rendered="{!(diagnosis.size=0)}" />
            </apex:pageBlockSection>
        </apex:pageBlock>

        <!--Admissions Section-->
        <a name="Adm" id="Adm"></a>
        <apex:pageBlock id="AdmissionListId">
            <div class="pbSubHeadButton">
                <apex:commandButton Value="Add New Admission" onclick="window.open('/apex/AdmissionEdit?pbsId={!Contact.Id}&retURL={!URLENCODE(currentUrl)}', '_self'); return false;" rendered="{!AND(canCreateAdm,disableAddAdm, isEditor)}" />
            </div>
            <apex:pageBlockSection title="Admissions" showHeader="true" columns="1" collapsible="false">
                <apex:pageblockTable value="{!admissions}" var="admsns" id="adminsId" rendered="{!(admissions.size>0)}">
                    <apex:column headerValue="Action">
                        <a href="/apex/AdmissionEdit?id={!admsns.ID}">Edit</a>
                    </apex:column>
                    <apex:column headerValue="Admission Name"><a href="/apex/AdmissionView?id={!admsns.ID}">{!admsns.Name}</a>
                    </apex:column>
                    <apex:column headerValue="Effective Date">
                        <c:MilitaryDatetime dateTimeVal="{!admsns.Admission_Effective_DateTime__c}" />           
                    </apex:column>
                    <apex:column value="{!admsns.Discharged_Date__c}" headerValue="Discharge Date" />
                    <apex:column value="{!admsns.Status__c}" headerValue="Status" />
                </apex:pageblockTable>
                <apex:outputText value="No admissions to display" rendered="{!(admissions.size=0)}" />
            </apex:pageBlockSection>
        </apex:pageBlock>
        <!-- Incidents Section Start -->
       	<apex:pageBlock id="incidentsBlock" rendered="{!$ObjectType.Incident__c.accessible}" >
            <apex:pageBlockSection columns="1" title="Incidents" id="incidentsSection" collapsible="false"  >
            <apex:outputText value="No Incident Records to Display" rendered="{!incidents.size= 0}" />
                <apex:pageBlockTable value="{!incidents}" var="i" rendered="{!incidents.size != 0}">
                	<apex:column headerValue="Incident Number" >
                		<a href="/{!i.id}" >{!i.Name}</a>
                	</apex:column>
                	<apex:column value="{!i.Service_Assignment__c}" />
                    <apex:column value="{!i.Recordtype.Name}" headerValue="Type"/>
                    <apex:column value="{!i.createdDate}" />
                </apex:pageBlockTable> 
            </apex:pageBlockSection>
        </apex:pageBlock>
        <!-- End Incidents Section -->
        <a id="allergy">
            <apex:pageBlock >
                <c:EvaluationResponseTable pbsParentId="{!PBSId}" type="Allergy" formId="{!$Component.FormID}" uniqueId="allergy" />
            </apex:pageBlock>
        </a>
            <a id="immunization"></a>
             <apex:pageBlock rendered="{! ( Assessments_ChildImmune.size != null || contact.Age__c < 18) && vfVarIsCM}" >
                <c:EvaluationResponseTable pbsParentId="{!PBSId}"
                                           type="Immunization - Child"
                                           formId="{!$Component.FormID}"
                                           uniqueId="Immunization_Child"
                                           rules="{&quot;Vaccine_Type__c&quot;: {&quot;Other&quot;: [&quot;Other__c&quot;]}}"
                                           cols="1"
                                           rows="5"
                                           showDisregard="true"
                                           eSign="true"
                                           addEnabled="{!contact.Age__c < 18}"
                                           editEnabled="{!contact.Age__c < 18}"
                                           enableReportButton="true"/>
            <apex:outputPanel >Showing the 5 most recent events click&nbsp;<apex:outputLink value="/apex/EvalResp_ShowAllList?PBS={!contact.id}&FS=Immunization - Child" >here</apex:outputLink>&nbsp;to view all</apex:outputpanel>
            </apex:pageBlock>
            
            <apex:pageBlock rendered="{! (contact.age__c != null && contact.Age__c > 17) && vfVarIsCM}" >
                <c:EvaluationResponseTable pbsParentId="{!PBSId}"
                                           type="Immunization - Adult"
                                           formId="{!$Component.FormID}"
                                           uniqueId="Immunization_Adult"
                                           rules="{&quot;Vaccine_Type__c&quot;: {&quot;Other&quot;: [&quot;Other__c&quot;]}}"
                                           cols="1"
                                           rows="5"
                                           showDisregard="true"
                                           eSign="true" 
                                           enableReportButton="true" />
            <apex:outputPanel >Showing the 5 most recent events click&nbsp;<apex:outputLink value="/apex/EvalResp_ShowAllList?PBS={!contact.id}&FS=Immunization - Adult" >here</apex:outputLink>&nbsp;to view all</apex:outputpanel>


            </apex:pageBlock>
            
            <apex:pageBlock rendered="{! vfVarIsCM}" >
                <c:EvaluationResponseTable pbsParentId="{!PBSId}"
                                           type="PPD Skin Test"
                                           formId="{!$Component.FormID}"
                                           uniqueId="PPD_SkinTest"
                                           rows="5"
                                           showDisregard="true"
                                           eSign="true"
                                           customLabels="[{&quot;field&quot;:&quot;Time_Given__c&quot;, &quot;label&quot;:&quot;Date Administered&quot;},{&quot;field&quot;:&quot;Time_Observed__c&quot;, &quot;label&quot;:&quot;Date Read&quot;}]"
                                           />
                                          
            <apex:outputPanel >Showing the 5 most recent events click&nbsp;<apex:outputLink value="/apex/EvalResp_ShowAllList?PBS={!contact.id}&FS=PPD Skin Test" >here</apex:outputLink>&nbsp;to view all</apex:outputpanel>
            </apex:pageBlock>
            <!-- added isNR for EB-430 by Amruth -->
            <apex:pageBlock rendered="{!vfVarIsCM}">
            <a id="assistiveDevices" />            
                <c:EvaluationResponseTable pbsParentId="{!PBSId}"
                                           type="Assistive Device"
                                           formId="{!$Component.FormID}"
                                           uniqueId="Assistive_Devices"
                                           visiblityRowRules="{&quot;Assistive_Device_Type__c&quot; : { &quot;Hearing Aid&quot; : [&quot;Hearing_Aid_Present__c&quot; , &quot;Hearing_Aid_Type__c&quot;],  
                                                                                                        &quot;Glasses&quot; : [&quot;Glasses_Contacts_Purpose__c&quot; , &quot;Glasses_Present__c&quot;],
                                                                                                        &quot;Contacts&quot; : [&quot;Glasses_Contacts_Purpose__c&quot; , &quot;Contacts_Type__c&quot; , &quot;Contacts_Present__c&quot;],
                                                                                                        &quot;Dentures&quot; : [&quot;Denture_Type__c&quot;],
                                                                                                        &quot;UE&quot; : [&quot;Assistive_Device_Removable__c&quot; , &quot;Assistive_Device_Restricts_Movement__c&quot;],
                                                                                                        &quot;LE&quot; : [&quot;Assistive_Device_Removable__c&quot; , &quot;Assistive_Device_Restricts_Movement__c&quot;],
                                                                                                        &quot;Seat Belt&quot; : [&quot;Assistive_Device_Removable__c&quot; , &quot;Assistive_Device_Restricts_Movement__c&quot;],
                                                                                                        &quot;Lap Tray&quot; : [&quot;Assistive_Device_Removable__c&quot; , &quot;Assistive_Device_Restricts_Movement__c&quot;],
                                                                                                        &quot;Trunk Supports&quot; : [&quot;Assistive_Device_Removable__c&quot; , &quot;Assistive_Device_Restricts_Movement__c&quot;],
                                                                                                        &quot;Enclosure Bed&quot; : [&quot;Assistive_Device_Removable__c&quot; , &quot;Assistive_Device_Restricts_Movement__c&quot;],
                                                                                                        &quot;Side Rail Half&quot; : [&quot;Side_Rail_Position__c&quot; , &quot;Assistive_Device_Removable__c&quot; , &quot;Assistive_Device_Restricts_Movement__c&quot;],
                                                                                                        &quot;Side Rail Full&quot; : [&quot;Side_Rail_Position__c&quot; , &quot;Assistive_Device_Removable__c&quot; , &quot;Assistive_Device_Restricts_Movement__c&quot;]
                                                                                                        }}"
                                           cols="1" 
                                           rows="5" />
                <apex:outputPanel >Showing the 5 most recent assistive devices click&nbsp;<apex:outputLink value="/apex/EvalResp_ShowAllList?PBS={!contact.id}&FS=Assistive Device" >here</apex:outputLink>&nbsp;to view all</apex:outputpanel>  
            </apex:pageBlock>
        <apex:pageBlock >
      
            <!--Task History Section-->
            <!--Open Tasks Section -->
            <apex:outputPanel style="display: block; width: 100%;">
                <apex:commandButton style="float: right;" onclick="window.open('/apex/PBS_AddTask_Page?PBS={!Contact.Id}&accID={!currentContact.AccountID}', '_self'); return false;" value="Add Task"/>
            </apex:outputPanel>
            <apex:pageBlockSection title="Open Tasks" showHeader="true" columns="1" collapsible="true">
                <apex:pageBlockTable value="{!taskOnCurrentPBSAccount}" var="OpenActivity" rendered="{!(taskOnCurrentPBSAccount.size>0)}">
                    <apex:column >
                        <apex:outputlink value="/{!OpenActivity.Id}">{!OpenActivity.Subject}</apex:outputLink>
                        <apex:facet name="header"> Subject </apex:facet>
                    </apex:column>
                    <apex:column >
                        <apex:outputLink value="/{!OpenActivity.WhoId}">{!OpenActivity.Who.Name}</apex:outputLink>
                        <apex:facet name="header"> Name</apex:facet>
                    </apex:column>
                    <apex:column >
                        <apex:outputLink value="/{!OpenActivity.OwnerId}">{!OpenActivity.Owner.Name}</apex:outputLink>
                        <apex:facet name="header"> Assigned To </apex:facet>
                    </apex:column>
                    <apex:column value="{!OpenActivity.LastModifiedDate}" />

                    <apex:column value="{!OpenActivity.Status}" />


                </apex:pageBlockTable>
                <apex:outputText value="No Tasks to display" rendered="{!(taskOnCurrentPBSAccount.size=0)}" />
                <apex:outputPanel rendered="{!taskOnCurrentPBSAccount.size!=0}">Showing the 10 most recent tasks click&nbsp;
                    <apex:outputLink value="/00T?id={!currentContact.AccountID}&rlid=RelatedActivityList">here</apex:outputLink>&nbsp;to view all</apex:outputpanel>
            </apex:pageBlockSection>

            <apex:pageBlockSection title="Task History" showHeader="true" columns="1" collapsible="true">

                <apex:pageBlockTable value="{!eventOnCurrentPBSAccount}" var="ActiveHis" rendered="{!(eventOnCurrentPBSAccount.size>0)}">

                    <apex:column >
                        <apex:outputlink value="/{!ActiveHis.Id}">{!ActiveHis.Subject}</apex:outputLink>
                        <apex:facet name="header"> Subject </apex:facet>
                    </apex:column>
                    <apex:column >
                        <apex:outputLink value="/{!ActiveHis.ID}">
                            <apex:outputText value="{0}">
                                <apex:param value="{!ActiveHis.ActivityDate}" />
                            </apex:outputText>
                        </apex:outputLink>
                        <apex:facet name="header"> Due Date</apex:facet>
                    </apex:column>
                    <apex:column >
                        <apex:outputLink value="/{!ActiveHis.WhoId}">{!ActiveHis.Who.Name}</apex:outputLink>
                        <apex:facet name="header"> Name</apex:facet>
                    </apex:column>
                    <apex:column >
                        <apex:outputLink value="/{!ActiveHis.OwnerId}">{!ActiveHis.Owner.Name}</apex:outputLink>
                        <apex:facet name="header"> Assigned To </apex:facet>
                    </apex:column>
                    <apex:column value="{!ActiveHis.LastModifiedDate}" />

                </apex:pageBlockTable>
                <apex:outputText value="No Tasks to display" rendered="{!(eventOnCurrentPBSAccount.size=0)}" />
                <apex:outputPanel rendered="{!eventOnCurrentPBSAccount.size!=0}">Showing the 10 most recent events click&nbsp;
                    <apex:outputLink value="/00T?id={!currentContact.AccountID}&rlid=RelatedActivityList">here</apex:outputLink>&nbsp;to view all</apex:outputpanel>

            </apex:pageBlockSection>
        </apex:pageBlock>
         </apex:form>
         </div>   
              <c:SObjectNotesAndAttachments parentId="{!Contact.id}" showAction="true" parentPage="PBS"></c:SObjectNotesAndAttachments> 
    
    <!--
        <apex:pageBlock >
            <!--Notes & Attachments
            <apex:pageBlockSection columns="1" title="Attachments" showHeader="true" collapsible="true">
                <apex:pageBlockSectionItem >
                    <a href="/apex/uploader?parentid={!Contact.id}">Add/Remove</a>
                </apex:pageBlockSectionItem>
                <apex:pageBlockTable value="{!attachments}" var="a" rendered="{!(attachments.size>0)}">
                    <apex:column headerValue="Attachment Name"><a href="/{!a.Id}">{!a.Name}</a>
                    </apex:column>
                </apex:pageBlockTable>
                <apex:outputText value="No Attachments to display" rendered="{!(attachments.size=0)}" />
            </apex:pageBlockSection>
        </apex:pageBlock> -->
        <apex:pageBlock >
            <!--PersonBeing Served History Section-->
            <apex:pageBlockSection title="Person Being Served History" showHeader="true" columns="1" collapsible="false">
                <apex:outputText />
                <apex:pageBlockTable value="{!personHistory}" var="PBSHistory" rendered="{!(personHistory.size>0)}">
                    <apex:column headerValue="Date" value=" {!PBSHistory.createddate}" />
                    <apex:column headerValue="User" value="{!PBSHistory.CreatedBy.Name}" />
                    <apex:column headerValue="Action">
                        <apex:outputPanel rendered="{! PBSHistory.field != ''}">
                            <apex:outputText rendered="{!(PBSHistory.field!='created')}">Changed <b>{!fieldMap[Lower(PBSHistory.field)]}</b> from <b>{!PBSHistory.oldvalue}</b> to <b>{!PBSHistory.newvalue}</b>
                            </apex:outputText>
                            <apex:outputText rendered="{!(PBSHistory.field='created')}">Created.</apex:outputText>
                        </apex:outputPanel>
                      
                    </apex:column>
                </apex:pageBlockTable>
                <apex:outputText value="No Recent History to display" rendered="{!(personHistory.size=0)}" />

            </apex:pageBlockSection>
        </apex:pageBlock>
</apex:page>