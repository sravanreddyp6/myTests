<apex:page controller="referralResults_Controller" >
<apex:includeScript value="{!URLFOR($Resource.jquery, 'js/jquery-1.7.2.min.js')}" />
<script>
j$ = jQuery.noConflict();
var validateInput = function( ) {

	var fname = j$('input[id$=fname]');
	var lname = j$('input[id$=lname]');
	var dob = j$('input[id$=dob]');
	var age = j$('input[id$=age]');
	var refID = j$('input[id$=rid]');
	
	var errors = '';
	j$('#searchErrors').html(errors);
	
	if ( refID.val() == '') {
	
		if ( fname.val() == '' && lname.val() == '' ) {
			errors += "<li>First and last name cannot both be blank.";
			}
			
		if ( dob.val() != '' && !Date.parse( dob.val())) {
			errors += "<li>Please enter a valid date of birth.";
		}
		if ( age.val() != '' && !parseFloat(age.val()) ) {
			errors += "<li>Please enter a valid age.";
		}	
		
		if ( errors != '' ) {
			j$('#searchErrors').html(errors);
			return false;
		}
	}
	return( searchRefs());
	


}
</script>
  
  <apex:form id="referralForm">
    <apex:actionFunction name="searchRefs" action="{!searchRefs}" rerender="refResultsBlock" />
 
    <apex:pageBlock mode="edit" >
 	<div id="searchErrors" style="color:red;padding:10px"/>
      <apex:facet name="header">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td class="pbTitle">
              <h2 class="mainTitle">Referral Search</h2>
            </td>
            <td>&nbsp;</td>
          </tr>
          </table>
      </apex:facet>
	
	  
      <apex:pageblockButtons location="bottom">
        <apex:commandButton value="Back" id="cancelButton"/>
      </apex:pageblockButtons>

      <apex:outputPanel layout="block">
      <apex:pageBlockSection title="Search for..."
                             columns="1"
                             collapsible="false"
                             id="PBRSection">
         
        <apex:pageBlockSectionItem >
            <apex:outputLabel >Referral Number</apex:outputLabel>
            <apex:inputText value="{!referralNumber}" id="rid" onblur="validateInput();"/>
        </apex:pageBlockSectionItem>
        <apex:inputText label="First Name" id="fname" value="{!personFirstName}" onblur="validateInput();"/>
        <apex:inputText label="Last Name" id="lname" value="{!personLastName}" onblur="validateInput();"/>
       <apex:inputText label="Date of Birth" id="dob" value="{!personDOB}" onblur="validateInput();"/>
       <apex:inputText label="Age" id="age" value="{!personAge}" onblur="validateInput();"/>
       <apex:inputText label="Gender" id="gender" value="{!personGender}" onblur="validateInput();"/>
      
      </apex:pageBlockSection>
      </apex:outputPanel>

      <apex:outputPanel id="refResultsBlock"
                        layout="block">
        <apex:pageBlockSection title="Search Results"
             columns="1"
             collapsible="false"
             id="ResultsSection">
          <apex:pageBlockTable value="{!refResults}" var="r">
            <apex:column headerValue="Referrals">
               <apex:repeat value="{!r.Referrals}" var="ref">
                  <a href="/{!ref.id}">{!ref.Name}</a><br/>
               </apex:repeat>     
            </apex:column>
            <apex:column headerValue="Name">{!r.LastName}, {!r.FirstName}</apex:column>
            <apex:column headerValue="Age">
              <apex:outputText value="{0, number, 0}">
                <apex:param value="{!r.Age}"/>
              </apex:outputText>
            </apex:column>
            <apex:column headerValue="Gender">{!r.gender}</apex:column>
            <apex:column headerValue="Address">
              <c:AddressDisplay Street1="{!r.Street1}"
                                Street2="{!r.Street2}"
                                City="{!r.City}"
                                State="{!r.State}"
                                Zip="{!r.ZipCode}"/>
            </apex:column>
            <apex:column headerValue="Type">{!r.Type}</apex:column>
            <apex:column headerValue="Action">
              <apex:outputPanel rendered="{!IF(AND(referralId == null,r.type == 'Person Being Referred',r.pbsonPBR==null), 'true', 'false')}">
                 <a href="/apex/referral?pbrID={!r.Id}">New Referral</a>
              </apex:outputPanel>
              <apex:outputPanel rendered="{!IF(AND(referralId == null,r.type == 'Person Being Served'), 'true', 'false')}">
                 <a href="/apex/referral?pbsID={!r.Id}">New Referral</a>
              </apex:outputPanel>
              <apex:outputPanel rendered="{!IF(AND(referralId != null,r.type == 'Person Being Referred', pbrId != r.ID), 'true', 'false')}">
                 <a href="/apex/referral?pbrID={!r.Id}&Id={!referralId}">Link Referral</a>
              </apex:outputPanel>
              <apex:outputPanel rendered="{!IF(AND(referralId != null,r.type == 'Person Being Served'), 'true', 'false')}">
                 <a href="/apex/referral?pbsID={!r.Id}&Id={!referralId}">Link Referral</a>
              </apex:outputPanel>
            </apex:column>
        </apex:pageBlockTable>
        </apex:pageBlockSection>
      </apex:outputPanel>
    </apex:pageBlock>
  </apex:form>
</apex:page>