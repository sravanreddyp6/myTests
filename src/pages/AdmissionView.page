<apex:page title="Admission: {!admission.Name}" standardController="Admission__c" extensions="AdmissionViewExtension,AdmissionDocumentController" standardStylesheets="true" sidebar="false"  tabStyle="Persons_Being_Served_New__tab">
<apex:stylesheet value="{!URLFOR($Resource.mentoresd,'/mentoresd.css')}" />
  <apex:includeScript value="{!URLFOR($Resource.jquery, 'js/jquery-1.7.2.min.js')}"/>
  <apex:includeScript value="{!URLFOR($Resource.jquery, 'js/jquery-ui-1.8.21.custom.min.js')}"/>
  <apex:stylesheet value="{!URLFOR($Resource.jquery, 'css/custom-theme/jquery-ui-1.8.21.custom.css')}"/>

  <style type="text/css">
    .dialogLoadingSpinner {
      margin-left: 5px;
    }
    /*.modalDialog {
      max-height: 500px;
      overflow: auto;
    }*/
    .modalDialog .modalSubheader {
      font-weight: bold;
    }
    .modalDialog .pbHeader {
      font-size: 0.9em;
    }
    .nowrap {
      white-space: nowrap;
    }
    .fixed-dialog{
        position: fixed;
        top:75px;
        left:100px;
        overflow-y:scroll;
        max-height:400px;
    }
    .fieldLabel {
        font-size:90%;
        color:#4a4a56;
        font-weight:bold;
    }
    .whitenoise { color:white; }
    .cssWait { cursor:wait;}
    .cssWaitComplete { cursor:auto;}
    span.fancytree-focused span.fancytree-title {
		outline: 2px ridge black;
	}
	.datePicker{z-index:1004;}
    
  </style>

 <script type="text/javascript">

                	        
(function ($) {
    openModalDialog = function (dialogId, tagType, titleString, dClass, width) {
        if (!width) {
            width = 1000;
        }
        if (!dClass) {
            dClass = 'fixed-dialog';
        }
        selector = tagType + '[id$=' + dialogId + ']';
        if ($(selector).dialog("isOpen")!==true) {
            $(selector).dialog({
                dialogClass: dClass,
                title:titleString,
                modal:true,
                width: width,
                resizable: false,
                minHeight: 0,
                dialogClass: 'modalDialog',
                closeOnEscape:false,
                position: {
                    my: "center top",
                    at: "center top"
                },
                open: function (event, ui) {
                     $("body").css("overflow", "hidden");
                   

                }
            }).parent().appendTo($('form[id$=admissionForm]'));
            $(selector).parent().find('a.ui-dialog-titlebar-close').remove();
        }
    };
    
    closeModalDialog = function (dialogId, tagType) {
        selector = tagType + '[id$=' + dialogId + ']';
        $(selector).dialog('destroy');
        // Allow "background" to be scrollable when dialogs are closed.
        $("body").css("overflow", "auto");
    };

    
    assignValue = function (elSelector, value) {
        var $el = $(document.getElementById(elSelector));
        $el.val(value);
    }
}) (jQuery.noConflict());


//j$ = jQuery.noConflict();
//j$(document).ready(function(){
//	var hstryblks = j$('img[id$=section1]');
//	j$.each( hstryblks, function( index, hstryblk) {
//			j$(this).trigger("click");
//	});
//});

var isModified = false;
var nodeKey = null;    
function recordChange(){
    isModified = true;
} 

function triggerNodeEdit(nK){
    nodeKey = nK.key;   
    if (isModified){
        $('[id*=dialog-confirm]').dialog( "open" );
    }
    else {
    
    	if(!nK.isFolder()){
			waitStart();
        	editNode(nodeKey);
        }
    }
 }
 
 function waitComplete(){
 	$('html, body').css("cursor", "auto");
 }
 
 function waitStart(){
	    $('html, body').css("cursor", "wait");
 }
 
 function showAddEditAdmissionDoc(){
 	waitStart();
 	showAddEditAdmissionDocAF();
 }

 function saveAdmissionDoc(){
 	waitStart();
 	saveAdmissionDocAF();
 }
  
 
 function triggerNodeSelection (treeNode) {
	waitStart();  
	updateDocSelectionAF(treeNode.key, treeNode.isSelected());  
 }
 </script>

<apex:variable value="{! $User.Operating_Group__c = 'Cambridge'}" var="showCans"/>
<apex:variable value="{! $User.Operating_Group__c = 'CareMeridian' || $User.Operating_Group__c = 'Care Meridian'}" var="isCM"/>
  
    <c:PersonalRecord pbsId="{!admission.Person_Being_Served__c}" parentPage="Admission" admId="{!admission.Id}"/>
    <br />
    <apex:form id="admissionForm">
    
	<apex:actionFunction name="saveAdmissionDocAF" action="{!saveAdmissionDoc}" rerender="associatedDocuments" oncomplete="waitComplete(),closeModalDialog('addAdmissionDocumentModal', 'span');" status="myStatus"/>
    <apex:actionFunction name="showAddEditAdmissionDocAF" action="{!showAddEditAdmissionDoc}" rerender="admissionDocumentyEntry,msgs" oncomplete="waitComplete()"/>

 <apex:actionFunction action="{!editTreeNode}" name="editNode" rerender="associatedDocDetails" oncomplete="waitComplete()" status="myStatus">
     <apex:param name="selectedKey" value="" />
 </apex:actionFunction>


 <apex:actionFunction action="{!updateDocSelection}" name="updateDocSelectionAF" rerender="associatedDocDetails" oncomplete="waitComplete()" status="myStatus">
     <apex:param name="selectedKey" value="" />
     <apex:param name="isSelected" value="" />     
 </apex:actionFunction>
 
 
     
    <!--  -->
    <apex:pageBlock title="Admission Detail">
    <div class="pbHeaderButton">
    <apex:commandButton onclick="window.open('/apex/AdmissionEdit?pbsId={!admission.Person_Being_Served__c}', '_self'); return false;" value="New Admission" rendered="{!canCreateAdm}"/>&nbsp;&nbsp;
    <apex:commandButton onclick="window.open('/apex/AdmissionEdit?id={!admission.ID}', '_self'); return false;" value="Edit Admission" rendered="{!isEditor}" />&nbsp;&nbsp;
    </div>
        
        <apex:pageBlockSection title="Information" columns="2" collapsible="false">
                <apex:outputField value="{!admission.name}"/>
                <apex:outputField value="{!admission.Status__c}" />
                <apex:outputField value="{!admission.Network_Offering__c}" />
                
                <apex:outputText label="Effective Date" value="{0, date, MM/dd/yyyy}" >
                    <apex:param value="{!admission.Effective_Date__c}" />
                </apex:outputText>
                <apex:outputField value="{!admission.State__c}" />
                
                <apex:outputText label="Discharged Date" value="{0, date, MM/dd/yyyy}">
                    <apex:param value="{!admission.Discharged_Date__c}" />
                </apex:outputText>
                <apex:pageBlockSectionItem /> <!--  empty field -->
                <apex:outputField value="{!admission.Discharged_Status__c}" />
                <apex:pageBlockSectionItem /> <!--  empty field -->
                <apex:outputField value="{!admission.Reason_for_Discharge__c}" />
                
    </apex:pageBlockSection>
    
        <br />
        <apex:pageBlockSection title="Referred-Out Details" collapsible="false">
        <apex:outputText label="Referred-Out Date" value="{0, date, MM/dd/yyyy}">
            <apex:param value="{!admission.Referred_Out_Date__c}" />
        </apex:outputText>
        <apex:pageBlockSectionItem />
        <apex:outputField value="{!admission.Referred_Out_Agency_Name__c}" />
        <apex:pageBlockSectionItem />
        <apex:outputField value="{!admission.Referred_Out_Reason__c}" />
        </apex:pageBlockSection>

        <apex:pageBlockSection title="System Information" collapsible="false">
        
        <apex:outputField label="Created By" value="{!admission.CreatedById}" />
        <apex:outputField label="Last Modified By" value="{!admission.LastModifiedById}" />
        <apex:outputField value="{!admission.CreatedDate}" />    
        <apex:outputField value="{!admission.LastModifiedDate}" />
        
    </apex:pageBlockSection>
    </apex:pageBlock>

    <br />
    <apex:pageBlock title="Authorizations" rendered="{!!isCM}">
        <apex:pageBlockTable styleclass="pbBody-list"  value="{!admission.Authorized_Services__r}" var="item" rendered="{!(admission.Authorized_Services__r!=null && admission.Authorized_Services__r.size>0)}">
            <apex:column ><apex:facet name="header">Authorization ID</apex:facet><apex:outputlink value="/{!item.id}">{!item.name}</apex:outputlink></apex:column>
            <apex:column value="{!item.Authorization_Status__c}"/>
            <apex:column value="{!item.Payer_Authorization_Date__c}"/>
            <apex:column value="{!item.Payer_Effective_Date__c}"/>
            <apex:column value="{!item.Payer_End_Date__c}"/>
            <apex:column value="{!item.Payer_Name__c}"/>
            <apex:column value="{!item.Number_Of_Authorized_Units__c}"/>
            <apex:column value="{!item.Remaining_Units__c}"/>
        </apex:pageBlockTable>
        <apex:outputText value="No records to display" rendered="{!(admission.Authorized_Services__r==null || admission.Authorized_Services__r.size=0)}" />
	</apex:pageBlock>
        
        
    <apex:pageBlock title="Admission Documents" rendered="{!isCM}"  id="associatedDocuments">
    	<div class="pbHeaderButton">
<!--           <input type="button" class="btn" value="Add/Edit Documents" id="addDocPacket" onClick="showAddEditAdmissionDoc();openModalDialog('addAdmissionDocumentModal', 'span', 'Add/Edit Documents'); return false;"/> -->
          <input type="button" class="btn" value="Add/Edit Documents" id="addDocPacket" onClick="openModalDialog('addAdmissionDocumentModal', 'span', 'Add/Edit Documents'); return false;"/>          
        </div>
		<apex:pageBlockTable styleclass="pbBody-list"  value="{!associatedDocs}" var="doc">
            <apex:column > <apex:facet name="header">Packet Name</apex:facet> {!doc.DocPacket__r.Packet_Name__c} </apex:column>
            <apex:column > <apex:facet name="header">Document Name</apex:facet> {!doc.Document__r.Document_Name__c} </apex:column>
            <apex:column > <apex:facet name="header">Effective Date</apex:facet><apex:outputField value="{!doc.Effective_Date__c}" /></apex:column>
            <apex:column > <apex:facet name="header">Filed Date</apex:facet> <apex:outputField value="{!doc.Filed_Date__c}" /> </apex:column>
            <apex:column > <apex:facet name="header">Status</apex:facet> {!doc.Status__c} </apex:column>
            <apex:column > <apex:facet name="header">Status Date</apex:facet><apex:outputField value="{!doc.Status_Date__c}" /></apex:column>
            
<!--             <apex:column > <apex:facet name="header">History</apex:facet><apex:pageBlockSection title="History" columns="1"  id="section1"> -->
<!--             <c:SObjectHistories object="{!doc}" title="Document History" /></apex:pageBlockSection> </apex:column> -->
<!--             <apex:column> <apex:facet name="header">Signature - Date</apex:facet> <apex:repeat value="{!doc.AssocDocSignatures__r}" var="signatures" id="theRepeat"> {!signatures.DocSignature__r.DocSigner__c} - <apex:outputField value="{!signatures.Signed_Date__c}" /><br/> </apex:repeat> </apex:column> -->
        </apex:pageBlockTable>
        <apex:outputText value="No records to display" rendered="{!(associatedDocs ==null || associatedDocs.size=0)}" />
	</apex:pageBlock>
	
	
	    <!-- Add/edit Admission Documents. -->
    <apex:outputPanel id="addAdmissionDocumentModal" style="display:none">
      <apex:pageBlock title="Add/Edit Documents">

        <apex:pageblockButtons location="bottom">
		<apex:actionStatus id="myStatus">
	        <apex:facet name="start">
	        	<div class="waitingHolder" style="display: inline; margin-left: 5px; position: relative; top: 5px;">
	            	<img class="waitingImage" src="/img/loading.gif" title="Please Wait..." /> <span class="waitingDescription"></span>
				</div>
	        </apex:facet>
            <apex:facet name="stop">
		        
		          <input type="button" value="Save" onClick="saveAdmissionDoc(true); " class="btn" />
		<!--           <input type="button" value="Close" onClick="closeModalDialog('addAdmissionDocumentModal', 'span'); j$('#admissionDocumentErrors').html('');j$('[id$=tree2]').fancytree('destroy');return false;"  class="btn"/> -->
		          <input type="button" value="Close" onClick="closeModalDialog('addAdmissionDocumentModal', 'span'); $('#admissionDocumentErrors').html('');return false;"  class="btn"/>          
         
            </apex:facet>
		</apex:actionStatus>
       		        </apex:pageblockButtons>            

        <apex:facet name="header">
          <p><strong>Check/Uncheck a document or packet to add/remove to the admission. Select document name to view/edit its details:</strong></p>
        </apex:facet>

        <div id='admissionDocumentErrors' style='color:red' ></div>

        <apex:pageBlockSection columns="2" id="admissionDocumentyEntry">

	       	<apex:outputPanel id="tree2" layout="block">
				<c:Fancy_Tree showIcons="true" TreeString="{!allDocsTree.Fancy_Tree_JSon_String_LongText}" allowInactiveNode="false" mode="3" activateActionSignature="triggerNodeEdit(data.node);" selectActionSignature="triggerNodeSelection(data.node);" checkbox="true" ID_PageSideStorage="catalog_items" TreeID="tree2" debug="false" />
		        <apex:inputHidden value="{!selectedKeys}" id="catalog_items"/>       
			</apex:outputPanel>

			<apex:outputPanel id="associatedDocDetails">
			<apex:outputPanel id="associatedDocDetail" layout="block" rendered="{! currrentAssocDoc.Status__c != '' }">
				<br/>
        	 	<table>
					<tr>
						<td><apex:outputText value="Effective Date" styleClass="labelCol"/></td>
						<td><apex:inputField value="{!currrentAssocDoc.Effective_Date__c}" id="currrentAssocDoc_Effective_Date"/></td>					
					</tr>
					<tr>
						<td><apex:outputText value="Recurring" styleClass="labelCol"/></td>
						<td><apex:inputField value="{!currrentAssocDoc.Recurring__c}" id="currrentAssocDoc_Recurring__c"/></td>					
					</tr>
					<tr>
						<td><apex:outputText value="Frequency" styleClass="labelCol"/></td>
						<td><apex:inputField value="{!currrentAssocDoc.Recurring_Frequency__c}" id="currrentAssocDoc_Recurring_Frequency"/></td>					
					</tr>
					<tr>
						<td><apex:outputText value="Due Days" styleClass="labelCol"/></td>
						<td><apex:inputField value="{!currrentAssocDoc.Due_Days__c}" id="currrentAssocDoc_Due_Days"/></td>					
					</tr>
					<tr>
						<td><apex:outputText value="Filed Date" styleClass="labelCol"/></td>
						<td><apex:inputField value="{!currrentAssocDoc.Filed_Date__c}" id="currrentAssocDoc_Filed_Date"/></td>					
					</tr>

					<tr>
						<td><apex:outputText value="Status" styleClass="labelCol"/></td>
						<td><apex:inputField value="{!currrentAssocDoc.Status__c}" id="currrentAssocDoc_Status"/></td>					
					</tr>
					<tr>
						<td><apex:outputText value="Status Date" styleClass="labelCol"/></td>
						<td><apex:inputField value="{!currrentAssocDoc.Status_Date__c}" id="currrentAssocDoc_Status_Date"/></td>
					</tr>
				</table>	
	        </apex:outputPanel>
			</apex:outputPanel>

        </apex:pageBlockSection>
      </apex:pageBlock>
    </apex:outputPanel>	
	



    <a name="Asmt" id="Asmt" ></a>
<apex:pageBlock title="Assessments" rendered="{!!isCM}">
        <div class="pbHeaderButton">
            <!-- <apex:commandButton rendered="{!assessmentTypes['CANS']}" onclick="window.open('/a0d/e?CF00NU00000036vU3={!admission.Name}&CF00NU00000036vU3_lkid={!admission.ID}', '_self'); return false;" value="New CANS Assessment" />&nbsp;&nbsp; -->
            <apex:commandButton rendered="{!(assessmentTypes['CANS'] &&  canCreateAsmt )&& showCans }" onclick="window.open('/apex/assessment_CANSdetail?admission={!admission.ID}&type={!CANsID}', '_self'); return false;" value="New CANS Assessment" />&nbsp;&nbsp;
            <apex:commandButton rendered="{!(assessmentTypes['Risk'] && riskAssessments.size=0 && canCreateAsmt ) && !showCans}" action="{!createRiskAssess}" value="New Risk Assessment" />
            <apex:commandButton rendered="{!(admission.State__c = 'MN' && issaAssessments.size=0 && canCreateAsmt ) && !showCans}" action="{!createIssaAssess}" value="New ISSA Assessment" />
            <apex:commandButton onclick="window.open('/{!Risk_Overview}?pv0={!Admission__c.Name}','_self'); return false;" rendered="{!(assessmentTypes['Risk'] && riskAssessments.size!=0 )}" value="Acknowledgment Overview" />
        </div>
        <apex:outputPanel rendered="{!(cansAssessments.size>0)}">
            <h1 style="display: block; margin-bottom: 30px;">CANS Assessments</h1>
            <apex:pageBlockTable styleclass="pbBody-list"  value="{!cansAssessments}" var="item">
                <apex:column headerValue="Name">
                    <apex:outputLink value="/{!item.ID}">{!item.Name}</apex:outputLink>
                </apex:column>
                <apex:column value="{!item.Assessment_Date__c}" />
                <apex:column value="{!item.Score__c}" />
                <apex:column headerValue="Owner">
                    <apex:outputLink value="/{!item.Owner.ID}">{!item.Owner.Name}</apex:outputLink>
                </apex:column>
            </apex:pageBlockTable>
        </apex:outputPanel>
        <apex:outputPanel rendered="{!(riskAssessments.size>0)}">
            <h1 style="display: block; margin-bottom: 30px;">Risk Assessments</h1>
            <apex:pageBlockTable styleclass="pbBody-list"  value="{!riskAssessments}" var="item" rendered="{!(riskAssessments.size>0)}">
                <apex:column headerValue="Name">
                    <apex:outputLink value="/{!item.ID}">{!item.Name}</apex:outputLink>
                </apex:column>
                <apex:column value="{!item.Status__c}" />
                <apex:column value="{!item.Finalized_Date__c}" />
                <apex:column headerValue="Owner">
                    <apex:outputLink value="/{!item.Owner.ID}">{!item.Owner.Name}</apex:outputLink>
                </apex:column>
            </apex:pageBlockTable>
        </apex:outputPanel>
        <apex:outputPanel rendered="{!(issaAssessments.size>0)}">
            <h1 style="display: block; margin-bottom: 30px;">ISSA Assessments</h1>
            <apex:pageBlockTable styleclass="pbBody-list"  value="{!issaAssessments}" var="item" rendered="{!(issaAssessments.size>0)}">
                <apex:column headerValue="Name">
                    <apex:outputLink value="/{!item.ID}">{!item.Name}</apex:outputLink>
                </apex:column>
                <apex:column value="{!item.Status__c}" />
                <apex:column value="{!item.Finalized_Date__c}" />
                <apex:column headerValue="Owner">
                    <apex:outputLink value="/{!item.Owner.ID}">{!item.Owner.Name}</apex:outputLink>
                </apex:column>
            </apex:pageBlockTable>
        </apex:outputPanel>
        <apex:outputText value="No records to display" rendered="{!(admission.Assessments__r == null || admission.Assessments__r.size=0)}" />
        </apex:pageBlock>
 <apex:pageBlock title="Service Assignments" >
        <div class="pbHeaderButton">
            <apex:commandButton onclick="window.open('/apex/ServiceAssignmentEditNew?save_new=1&admissionID={!admission.ID}&RecordType=Standard Service Assignment', '_self'); return false;" value="New Standard Service" rendered="{!canCreateSvc}"/>&nbsp;&nbsp;
            <apex:commandButton onclick="window.open('/apex/ServiceAssignmentEditNew?save_new=1&admissionID={!admission.ID}&RecordType=Assessment Only', '_self'); return false;" value="New Assessment Only"   rendered="{!canCreateSvc && !isCM}"/>
        </div>
        
        <apex:pageBlockTable styleclass="pbBody-list" value="{!admission.Service_Agreements__r}" var="item" rendered="{!(admission.Service_Agreements__r!= null && admission.Service_Agreements__r.size>0)}">
            <apex:column headerValue="Action"><apex:outputLink value="/apex/ServiceAssignmentEditNew?id={!item.ID}&edit_link=1">Edit</apex:outputLink></apex:column>
            <apex:column headervalue="Name"><apex:outputLink value="/{!item.ID}">{!item.name}</apex:outputLink></apex:column>
            <apex:column value="{!item.Status__c}"/>
            <apex:column headerValue="Start Date">
                <apex:outputText value="{0, date, MM/dd/yyyy}">
                    <apex:param value="{!item.Start_Date__c}" />
                </apex:outputText>
            </apex:column>
            <apex:column headerValue="End Date">
                <apex:outputText value="{0, date, MM/dd/yyyy}">
                    <apex:param value="{!item.End_Date__c}" />
                </apex:outputText>
            </apex:column>
        </apex:pageBlockTable>
        <apex:outputText value="No records to display" rendered="{!(admission.Service_Agreements__r == null || admission.Service_Agreements__r.size=0)}" />
</apex:pageBlock>

  
    
    </apex:form>
 <c:SObjectNotesAndAttachments parentId="{!admission.id}" showAction="false" ></c:SObjectNotesAndAttachments> 
<c:SObjectHistories object="{!admission}" title="Admission History" />   
</apex:page>