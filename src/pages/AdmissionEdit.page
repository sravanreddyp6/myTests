<apex:page title="Admission Edit: {!admission.Name}" standardController="Admission__c" extensions="AdmissionEditExtension" standardStylesheets="false" sidebar="false" tabStyle="Persons_Being_Served_New__tab">
<apex:stylesheet value="{!URLFOR($Resource.mentoresd,'/mentoresd.css')}" />
<apex:stylesheet value="{!URLFOR($Resource.datetimepicker,  'datetimepicker/jquery.datetimepicker.css')}" />
<apex:includeScript value="{!URLFOR($Resource.jquery, 'js/jquery-1.7.2.min.js')}" />
<apex:includeScript value="{!URLFOR($Resource.datetimepicker, 'datetimepicker/jquery.datetimepicker.js')}" />
<apex:includeScript value="{!URLFOR($Resource.momentJs)}" />
<script type="text/javascript">
function setFocusOnLoad() {}
j$ = jQuery.noConflict();
var isDischarge = false;
//var admissionDateTime = {
        var intializeDateTimePicker = function($target) {
            console.log('called initializedatetimepicker', $target);
            jQuery($target).datetimepicker({
                format: 'm/d/Y H:i',
                onGenerate: function(dp, $input) {
                    j$('.xdsoft_datetimepicker.xdsoft_.xdsoft_noselect').css("top", "+=10");
                }
            });
            if ($target.length === 1){
                      j$($target).val((moment($target.val().toString()).format('L LT') == 'Invalid date' ? '' : moment($target.val().toString()).format('L HH:mm')).toString());
            }
        }
        var updateDateTime = function($target) {
            console.log('called updateDateTime', $target);
            j$($target).val((moment($target.val().toString()).format('L LT') == 'Invalid date' ? '' : moment($target.val().toString()).format('L LT')));
             
        }
//    }
    

j$( document ).ready(function() {
    setupDates(); 
});

function setDischargeFlag () {
    isDischarge = ( j$('select[id$=admStatus]').val() == 'Discharged') && {!useDischargeSection};
}

function updateDates() {
    updateDateTime(j$('input[id$=admissionEffectiveDateTime]'))
    if ( isDischarge )
        updateDateTime(j$('input[id$=dischargeddatetime]'));
}

function setupDates() {
    intializeDateTimePicker(j$('input[id$=admissionEffectiveDateTime]'));
    if ( isDischarge )
        intializeDateTimePicker(j$('input[id$=dischargeddatetime]'));
    
}

</script>
    
    <c:PersonalRecord pbsId="{!admission.Person_Being_Served__c}" parentPage="Admission" admId="{!Admission__c.Id}" rendered="{!showPersonalCard}"/>
    <br />
    <apex:form >
    <apex:pageMessages id="msgs"/>
        <apex:pageBlock title="Admission Edit" id="detail" mode="edit">
            <div class="pbHeaderButton" id="buttons">
                <apex:commandButton value="Save" id="btnSave" action="{!saveAdmission}" status="mySaveStatus" onClick="updateDates()" rerender="msgs, detail" onComplete="setDischargeFlag(); setupDates()"/>
                <apex:commandButton action="{!cancel}" value="Cancel"/>
            </div>
            <apex:pageBlockSection title="Information" id="info" columns="2">
                <apex:outputField value="{!admission.Name}" />
                <apex:pageblocksectionitem >
                <apex:outputLabel for="admstatus" value="Status" />
                <apex:outputPanel >
                    <apex:inputField id="admStatus" value="{!admission.Status__c}" >
                    <apex:actionSupport event="onchange" onsubmit="updateDates();" rerender="detail" action="{!setDischargeFields}" oncomplete="setDischargeFlag(); setupDates()"/>
                    </apex:inputField>
                </apex:outputPanel>
                </apex:pageblocksectionitem>
                <apex:outputField value="{!admission.Person_Being_Served__c}" />
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Effective Date" />
                    <apex:outputPanel >
                        <div class="requiredInput">
                            <div class="requiredBlock"></div>
                            <apex:inputText id="admissionEffectiveDateTime" value=" {!admission.Admission_Effective_DateTime__c}" required="true" />
                        </div>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:inputField value="{!admission.Network_Offering__c}" required="true" />
                <apex:inputField value="{!admission.Discharged_Date__c}" rendered="{! !useDischargeSection }"/>
                <apex:outputText value="" rendered="{! useDischargeSection }" />
                <apex:inputField value="{!admission.State__c}" required="true" />
                <apex:inputField value="{!admission.Discharged_Status__c}" rendered="{! !useDischargeSection }"/>
                <apex:pageBlockSectionItem />
                <apex:inputField value="{!admission.Reason_for_Discharge__c}" rendered="{! !useDischargeSection }"/>
            </apex:pageBlockSection>
            
            <apex:pageBlockSection id="dischargeinfo" title="Discharge Details" collapsible="false" rendered="{! useDischargeSection && admission.status__c == 'Discharged'}" >
            <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Discharged Date/Time" />
                    <apex:outputPanel >
                <div class="requiredInput">
                    <div class="requiredBlock"></div>
                    <apex:inputtext id="dischargeddatetime" value=" {!admission.Discharged_Date_Time__c}" />
                </div>
                </apex:outputPanel>
                </apex:pageBlockSectionItem>
                
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Planned Discharge" />
                    <apex:outputPanel >
                	<div class="requiredInput">
                    <div class="requiredBlock"></div>
                	<apex:inputField value="{!admission.planned_discharge__c}" />
                
                </div>
                </apex:outputPanel>
                </apex:pageBlockSectionItem>
                
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Discharged To" />
                    <apex:outputPanel >
                	<div class="requiredInput">
                    <div class="requiredBlock"></div>
	                <apex:inputField id="dischargetocat" value="{!admission.Discharged_To_Category__c}" />
	                </div>
	                </apex:outputPanel>
                </apex:pageBlockSectionItem>
                <apex:inputField id="dischargetodesc" value="{!admission.Discharged_to_desc__c}" />
                <apex:inputField value="{!admission.Discharged_To_Subcategory__c}" />
                <apex:inputField id="dischargetoother" value="{!admission.Discharged_to_other__c}"  />
                <apex:inputField value="{!admission.Discharged_To_Additional__c}" />
                <apex:pageblocksectionitem >
                <apex:outputLabel for="referredoutname" value="Facility Name" />
                <apex:inputField id="referredoutname" value="{!admission.Referred_Out_Agency_Name__c}" />
                </apex:pageblocksectionitem>
                <apex:outputText value="<hr />" escape="false" />
                <apex:outputText value="<hr />" escape="false" />


				<apex:pageBlockSectionItem >
                    <apex:outputLabel value="Discharged Reason" />
                    <apex:outputPanel >
                	<div class="requiredInput">
                    <div class="requiredBlock"></div>
                	<apex:inputField value="{!admission.discharged_reason__c}" />
                
                </div>
                </apex:outputPanel>
                </apex:pageBlockSectionItem>
                
                <apex:pageBlockSectionItem>
                <apex:outputLabel value="Reason Other" />
                <apex:inputField value="{!admission.reason_for_discharge__c}" />
                </apex:pageBlockSectionItem>
                <apex:inputField value="{!admission.discharged_reason_subcategory__c}" />
                <apex:outputText value="" />
                <apex:inputField value="{!admission.discharged_reason_additional__c}" />
                <apex:outputText value="" />
                
                <apex:inputField value="{!admission.Additional_Discharge_info__c}" />
                <apex:outputText value="" />
            </apex:pageBlockSection>
            
            <apex:pageBlockSection title="Referred-Out Details" columns="1" rendered="{! !useDischargeSection }">
                <apex:inputField value="{!admission.Referred_Out_Date__c}" />
                <apex:inputField value="{!admission.Referred_Out_Agency_Name__c}" />
                <apex:inputField value="{!admission.Referred_Out_Reason__c}" />
            </apex:pageBlockSection>
        </apex:pageBlock>
    </apex:form>

<apex:actionStatus id="mySaveStatus">
    <apex:facet name="start">
        <style>
            .thinkingwheel {
                position: fixed;
                left: 50%;
                top: 50%;
                background-color: white;
                border: 2px solid gray;
                padding: 2px;
                z-index: 2000;
            }            
            .foggy {
                opacity: 0.8;
                background-color: #ccc;
                position: fixed;
                width: 100%;
                height: 100%;
                top: 0px;
                left: 0px;
                z-index: 1000;
            }
        </style>
        <div class="foggy"></div>
        <div class="thinkingwheel">
            <span><img class="waitingImage" src="/img/loading.gif" title="Please Wait..." /> Processing . . . </span>
        </div>
    </apex:facet>
    <apex:facet name="stop"> </apex:facet>
</apex:actionStatus>


</apex:page>