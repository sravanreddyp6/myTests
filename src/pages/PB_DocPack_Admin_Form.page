<apex:page standardController="PB_DocPacket__c" extensions="PB_DocPack_Admin_Form" sidebar="false" >
    <apex:stylesheet value="{!URLFOR($Resource.jquery, 'css/custom-theme/jquery-ui-1.8.21.custom.css')}"/>
    <apex:includeScript value="{!URLFOR($Resource.jquery, 'js/jquery-1.7.2.min.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.jquery, 'js/jquery-ui-1.8.21.custom.min.js')}" />
<script type="text/javascript">
$ = jQuery.noConflict();
var isModified = false;
var itemsModified = [];

var nodeKey = null;    
function recordChange(item){
    isModified = true;
    
    itemsModified.push(item);
    document.getElementById("changedItems").innerHTML = itemsModified;
} 
function triggerNodeEdit(nK){
    nodeKey = nK;  
    console.log('key' + nodeKey); 
    if (isModified){
        $('[id*=dialog-confirm]').dialog( "open" );
    }
    else {
        editNode(nodeKey);
    }
 }
$(function() {
    $('[id*=dialog-confirm]').dialog({
      resizable: false,
      height:180,
      modal: true,
      autoOpen: false,
      buttons: {
        Yes: function() {
            $( this ).dialog( "close" );
            $('[id*=SaveNode]').trigger("click");           
        },
        No: function() {
            $( this ).dialog( "close" );
            isModified = false;  
            var itemsModified = [];        
            editNode(nodeKey);
        }
      }
    });
});
</script>
<apex:outputPanel id="fullpage">
<div class="fogBG noDisplay" />

<apex:outputPanel id="dialog-confirm" title="Confirm save" layout="block">
    <apex:outputPanel layout="inline">
        
        
        The Following fields have changed - <br/>
        <span id="changedItems"></span>
        <br/><br/><p/>Do you want to save before navigating away?
    </apex:outputPanel>
</apex:outputPanel>

<div class="frm-Container">
<apex:form >
<apex:actionFunction action="{!editItem}" name="editNode" reRender="miniForm" status="myStatus" immediate="true">
    <apex:param name="itemID" value=""/>
</apex:actionFunction>
    <div class="left-Col">
        <apex:pageBlock title="Packets and Documents">
            <apex:pageBlockButtons location="top">
                <apex:commandButton value="Add New Item" action="{!resetMiniForm}" reRender="miniForm" status="myStatus"/>
            </apex:pageBlockButtons>
                <apex:outputPanel id="abcd"  >
                    <c:Fancy_Tree TreeString="{!dataTree.Fancy_Tree_JSon_String_LongText}" mode="1" activateActionSignature="triggerNodeEdit(data.node.key);" checkbox="false" allowInactiveNode="true"  TreeID="abcd" debug="false" />    
                </apex:outputPanel>       
        </apex:pageBlock>   
    </div>
    
    <div class="right-Col">
        <apex:pageBlock title="" id="miniForm">
            <apex:pageBlockSection columns="1">
                <apex:pageMessages ></apex:pageMessages>
                <apex:pageBlockSectionItem >
                    Type    
                    <apex:actionRegion >
                        <apex:selectList value="{!SelectedItemOption}" size="1">
                            <apex:selectOptions value="{!ItemOptions}"></apex:selectOptions>
                            <apex:actionSupport event="onchange" reRender="newItemDataElements" action="{!setSelectiblePacketsForDocumentsTree}" status="myStatus"  />
                        </apex:selectList> 
                    </apex:actionRegion>               
                </apex:pageBlockSectionItem>
            </apex:pageblockSection>  
            <apex:pageBlock id="newItemDataElements">  
                <apex:pageBlockButtons >
                    <apex:commandButton action="{!SaveDoc}" id="DocSaveNode" value="Save Document" rendered="{!SelectedItemOption == 'Document'}" status="myStatus" reRender="fullpage"/>
                    <apex:commandButton action="{!SavePack}" id="PackSaveNode" value="Save Packet" rendered="{!SelectedItemOption == 'Packet'}" status="myStatus" reRender="fullpage"/>
                </apex:pageBlockButtons>
                <apex:pageBlockSection columns="1" rendered="{!SelectedItemOption == 'Packet'}" >
                    <apex:inputField value="{!SelectedDocPacket.Packet_Name__c}"/>
                    <apex:inputField value="{!SelectedDocPacket.Status__c}"/>
                </apex:pageBlockSection>
                <apex:pageBlockSection columns="1" rendered="{!SelectedItemOption == 'Document'}" >
                    <apex:inputField value="{!SelectedDocument.Document_Name__c}" onchange="recordChange('Document Name')"/>
                    <apex:inputField value="{!SelectedDocument.Version__c}" onchange="recordChange('Version')"/>
                    <apex:inputField value="{!SelectedDocument.Status__c}" onchange="recordChange('Status')"/>
                    <apex:inputField value="{!SelectedDocument.Type__c}" onchange="recordChange('Type')"/>                    
                    <apex:inputField value="{!SelectedDocument.Effective_Date__c}" onchange="recordChange('Effective Date')"/>
                    <apex:inputField value="{!SelectedDocument.Expiration_Date__c}" onchange="recordChange('Exiration Date')"/>
                    <apex:inputField value="{!SelectedDocument.Due_Days__c}" onchange="recordChange('Due Days')"/>
                    <apex:inputField value="{!SelectedDocument.Recurring__c}" onchange="recordChange('Recurring')"/>
                    <apex:inputField value="{!SelectedDocument.Recurring_Frequency__c}" onchange="recordChange('Recurring Frequency')"/>
                    <apex:inputText style="display: none;" id="miniFormTreeSelectedItems" value="{!miniFormTreeSelectedKeys}" onchange="recordChange('Related Packets')"/>
                    
                    <div id="miniFormTree">
                        <c:Fancy_Tree TreeString="{!miniFormTreeForDocs.Fancy_Tree_JSon_String_LongText}" mode="2" checkbox="true" ID_PageSideStorage="miniFormTreeSelectedItems" allowInactiveNode="false"  TreeID="miniFormTree" debug="false" />
                    </div>                     
                </apex:pageBlockSection>      
         
            </apex:pageBlock>
        
        </apex:pageBlock>
    
    </div>

</apex:form>
</div>
</apex:outputPanel>

<style>
.dateFormat{ display: none;)
</style>
<style>
#datePicker{z-index: 1200;}
.noOverflow{ overflow: hidden;}
.fRight{float: right;}

.frm-Container{ width: 1200px;}
.left-Col, .right-Col{float: left; padding: 10px;}
.left-Col{width: 650px;}
.right-Col{width: 350px;}


.h-line{border-bottom: 1px rgba(0, 0, 0, 0.05) solid; width: 100%; margin-top: 3px; margin-bottom: 3px;}

.container-fluid{margin-top: 3px;}
.noDisplay{display: none;}

.fogBG{
    opacity:0.8;
    background-color:#ccc;
    position:fixed;
    width:100%;
    height:100%;
    top:0px;
    left:0px;
    z-index:100;
}
.pop-up{
    position: fixed;
    top: 5px;
    width: 95%;
    height: 95%;
    min-height: 700px;
    overflow: auto;
    z-index:200;
    border: 3px solid #222222;
    border-radius: 7px;
    background-color: #AEAEAE;
    padding: 10px;
    
}
.sticky {
    position:fixed;
    top:0px;
    padding: 5px;
    
    z-index: 50;
    width: 98%;
}
#top-sticky{
    //width: 100%;
    background-color: white;
    border-bottom: 1px solid black;
    padding: 10px;
}
#top-sticky h2{text-transform: uppercase;}
</style>
<script>
    $ = jQuery.noConflict();

</script>

<apex:actionStatus id="myStatus" >
    <apex:facet name="start">  
            <style>
            .thinkingwheel{position: fixed; left:50%; top:50%; background-color: white; border: 2px solid gray; padding: 2px; z-index: 2000;}
        .foggy{
            opacity:0.8;
            background-color:#ccc;
            position:fixed;
            width:100%;
            height:100%;
            top:0px;
            left:0px;
            z-index:1000;
        }  
        </style>

        <div class="foggy" />        
        <div class="thinkingwheel" >    
            <span><img class="waitingImage" src="/img/loading.gif" title="Please Wait..." /> Processing . . . </span>
        </div> 
    </apex:facet>  
    <apex:facet name="stop"> </apex:facet>         
</apex:actionStatus>
</apex:page>