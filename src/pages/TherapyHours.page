<apex:page controller="TherapyHours" docType="html-5.0"  showHeader="false" sidebar="false" cache="true" 
applyHtmlTag="false" applyBodyTag="false" standardStylesheets="false" >
<html>
  <head>
    <apex:stylesheet value="{!URLFOR($Resource.jQueryMobile, 'jQueryMobile/Latest/jquery.mobile-1.4.5.min.css')}"/>
    <apex:includeScript value="{!URLFOR($Resource.jQueryMobile, 'jQueryMobile/jquery-1.9.1.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.jQueryMobile,'jQueryMobile/Latest/jquery.mobile-1.4.5.min.js')}"/>
  
<!--     <apex:stylesheet value="{!URLFOR($Resource.jQueryMobile, 'jQueryMobile/jquery.mobile-1.3.0.min.css')}"/> -->
<!--     <apex:includeScript value="{!URLFOR($Resource.jQueryMobile, 'jQueryMobile/jquery-1.9.1.min.js')}"/> -->
<!--     <apex:includeScript value="{!URLFOR($Resource.jQueryMobile,'jQueryMobile/jquery.mobile-1.3.0.min.js')}"/> -->
    <apex:includeScript value="{!URLFOR($Resource.jQueryMobile,'jQueryMobile/moment.min.js')}"/>
        
    <apex:remoteObjects >
        <apex:remoteObjectModel name="Contact" fields="Id,Lastname,FirstName" jsShorthand="cont">
        </apex:remoteObjectModel>
        <apex:remoteObjectModel jsShorthand="serviceAssignment" name="Service_Assignment__c" fields="Id,pbsLastName__c,pbsFirstName__c">
            <apex:remoteObjectField name="Service_Location__c" jsShorthand="ServiceLocation"/>
        </apex:remoteObjectModel>
        <apex:remoteObjectModel jsShorthand="myHoursObj" name="Therapy_Hour__c" 
            fields="Id,Name,Appointment_Type__c,Approver_Note__c,End_Time__c,Narrative_Note__c,Start_Time__c,Status__c,pbsLastName__c,pbsFirstName__c,createdDate,Number_of_Hours__c">
        </apex:remoteObjectModel>
    </apex:remoteObjects>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <script type="text/javascript">
        //if(self != top) { top.location = self.location; }
        var $j = jQuery.noConflict();
        var myHours = new SObjectModel.myHoursObj();
        var sa = new SObjectModel.serviceAssignment();
        myHours.errorHandler = displayError;
        $j(document).on('ready', function() {
                regBtnClickHandlers();
                getAllTimeEntries();
        });
        function getAllTimeEntries() {
            myHours.retrieve(
                {   orderby: [ {createdDate: 'DESC'} ],
                    limit: 100
                },
                function(error, records) {
                    if (error) {
                        displayError(error);
                    } else {
                        showAllTimeEntries(records);
                    }
                }
            );
        }
        function showAllTimeEntries(records) {    
                $j('#cMyHoursList').empty();
                records.forEach(function(record) {
                    var newLi = $j('<li></li>');
                    var newLink = $j('<a id="' +record.get("Id")+ '" data-transition="flip">' + record.get("Name") + ' - ' +  record.get("Status__c") + '</a>');
                    newLink.click(function(e) {
                        e.preventDefault();
                        $j('#error').html('');
                        $j('#myHoursDetail').html('');
                        var table = '<table>';
                        table += '<tr><td><strong>Person Being Served:<strong></td><td>' + record.get("pbsFirstName__c") + ' ' + record.get("pbsLastName__c") + '</td></tr>';
                        table += '<tr><td><strong>Appointment Type:<strong></td><td>' + record.get("Appointment_Type__c") + '</td></tr>';
                        table += '<tr><td><strong>Status:<strong></td><td>' + record.get("Status__c") + '</td></tr>';
                        table += '<tr><td><strong>Start Time:<strong></td><td>' + formatDateTime(record.get("Start_Time__c")) + '</td></tr>';
                        table += '<tr><td><strong>End Time:<strong></td><td>' + formatDateTime(record.get("End_Time__c")) + '</td></tr>';
                        table += '<tr><td><strong>Number of Hours:<strong></td><td>' + record.get("Number_of_Hours__c") + '</td></tr>';
                        table += '<tr><td><strong>My Notes:<strong></td><td>' + record.get("Narrative_Note__c") + '</td></tr>';
                        table += '<tr><td><strong>Approvers Notes:<strong></td><td>' + record.get("Approver_Note__c") + '</td></tr>';
                        table += '</table>';
                        $j('#myHoursDetail').html(table);
                        $j.mobile.changePage('#detailpage', {changeHash: true});
                    });
                    newLi.append(newLink);            
                    newLi.appendTo('#cMyHoursList');
                  });
                
                $j.mobile.loading('hide');
                $j('#cMyHoursList').listview('refresh');
        }      
        function successCallback(){
            getAllTimeEntries();
            $j.mobile.changePage('#listpage', {changeHash: true});
        }
        function displayError(e){
            $j('#error').html(e.message);
        }
        function formatDateTime(val){
            return moment(val).format('L LT');
        }
        function regBtnClickHandlers() {
            $j('#add').click(function(e) {
                    e.preventDefault();
                    $j.mobile.loading('show');
                    $j('[Id$=selectprograms]').val('');
                    $j('[Id$=selectprograms]').trigger('change');
                    $j('#entryType').val('');
                    $j('#startDateTime').val('');
                    $j('#endDateTime').val('');
                    $j('#numberOfHours').html('');
                    $j('#narrativeNotes').val('');
                    $j('#error').html('');
                    $j.mobile.changePage('#detailpageAdd', {changeHash: true});
                    $j.mobile.loading('hide');
            });
            $j('#save').click(function(e) {
                   saveTimeEntry(e);
            });
            $j('#cancel').click(function(e) {
                    e.preventDefault();
                    $j.mobile.loading('show');
                    $j.mobile.changePage('#listpage', {changeHash: true});
                    $j.mobile.loading('hide');
            });
            $j('.datetime').on('change', function(e) {
                var hoursDiff = moment(document.getElementById('endDateTime').value).diff(moment(document.getElementById('startDateTime').value),'Hours', true);
                $j('#numberOfHours').html('Number of hours: ' + (isNaN(hoursDiff) ? '0' : hoursDiff ) );
            });
        }
        function getPbs() {
            $j.mobile.loading('show');
            var ul = $j('#pbsList');
            var searchTerm = document.querySelector("[Id$=selectprograms]").value;
            sa.retrieve(
                {   where: { ServiceLocation : {eq: searchTerm}},
                    limit: 100
                },
                function(error, records) {
                    if (error) {
                      displayError(error);
                    } else {
                        ul.empty();
                        records.forEach(function(record) {
                            ul.append($j('<option></option>').attr("value", record.get("Id")).text(record.get("pbsFirstName__c") + " " + record.get("pbsLastName__c")));
                        });
                        ul.selectmenu('refresh');
                        $j.mobile.loading('hide');
                    }
                }
            );
        }
        function saveTimeEntry(e) {
            e.preventDefault();
            var dataObj = $j('#myForm').serializeArray();
            var formdata = {};
            $j(dataObj).each(function(index, obj){
                formdata[obj.name] = obj.value;
            });
            $j.mobile.loading('show');
                    TherapyHours.saveFields(
                        JSON.stringify(formdata),
                        function (result, event) {
                            if (event.status) { // Success
                                successCallback();
                                $j.mobile.loading( 'hide' );
                                alert('Submitted successfully.');
                            } else {
                                displayError(event);
                                $j.mobile.loading( 'hide' );
                            }
                       });
        }
    </script>
</head>
<body>
    <div data-role="page" data-theme="a" id="listpage" data-dom-cache="true">                
        <div data-role="header" data-position="fixed" data-theme="a">
            <h2>My Hours</h2>
            <a href='#' id="add" class='ui-btn-right' data-icon='plus' data-theme="b">Add</a>
        </div>
        <div role="main" class="ui-content" id="myHoursList">            
            <ul id="cMyHoursList" data-filter="true" data-inset="true" data-role="listview" data-theme="a"> </ul>
        </div>
    </div>
    <div data-role="page" data-theme="a" id="detailpage">                
        <div data-role="header" data-position="fixed">
                <a href='#listpage' class='ui-btn-left' data-theme="b" data-icon='arrow-l' data-direction="reverse" data-transition="slide">Back</a>
                <h1>Details</h1>
        </div>
        <div role="main" class="ui-content" id="myHoursDetail">
        </div>
    </div>        
    <div data-role="page" data-theme="a" id="detailpageAdd">
        <div data-role="header" data-position="fixed">
                <a href='#listpage' class='ui-btn-left' data-theme="b" data-icon='arrow-l' data-direction="reverse" data-transition="slide">Back</a>
                <a id="save" data-icon="check" data-theme="b" class='ui-btn-right'>Submit</a>
                <h1>Submit Hours</h1>
        </div>
        <div role="main" class="ui-content">
            <form id="myForm">
                <h2 style="color:red" id="error"></h2>
                <div data-role="fieldcontain" class="ui-field-contain">
                    <label for="selectprograms">Program Location:</label>
                    <select name="selectprograms" id="selectprograms"  onChange="getPbs();">
                           <apex:outputText value="{!programslist}" escape="false"/> 
                    </select>
                </div>
                <div data-role="fieldcontain" class="ui-field-contain">
                    <label for="pbsList">Person Being Served:</label>
                    <select name="pbsList" id="pbsList"  ></select>
                </div>
                <div data-role="fieldcontain" class="ui-field-contain">
                    <label for="entryType">Appointment Type:</label>
                    <select name="entryType" id="entryType"  >
                        <option value="Individual Treatment">Individual Treatment</option>
                        <option value="Initial Evaluation">Initial Evaluation</option>
                        <option value="Administrative">Administrative</option>
                        <option value="Monthly Evaluation">Monthly Evaluation</option>
                        <option value="Quarterly Evaluation">Quarterly Evaluation</option>
                        <option value="Group Treatment">Group Treatment</option>
                        <option value="DC Evaluation">DC Evaluation</option>
                        <option value="Conference">Conference</option>
                    </select>
                </div>
                <div data-role="fieldcontain" class="ui-field-contain">
                    <label for="startDateTime">Start Time:</label>
                    <input type="datetime-local" id="startDateTime" name="startDateTime" class="datetime"/>
                </div>
                <div data-role="fieldcontain" class="ui-field-contain">
                    <label for="endDateTime">End Time:</label>
                    <input type="datetime-local" id="endDateTime" name="endDateTime" class="datetime"/>
                </div>
                <div data-role="fieldcontain" class="ui-field-contain">
                    <label for="numberOfHours"></label>
                    <div style="color:red" id="numberOfHours"></div>
                </div>
                <div data-role="fieldcontain" class="ui-field-contain">
                    <label for="narrativeNotes">Notes:</label>
                    <textarea rows="3" id="narrativeNotes" name="narrativeNotes"></textarea>
                </div>
<!--                 <fieldset class="ui-grid-a"> -->
<!--                     <div class="ui-block-a"><input type="button" id="save" data-icon="check" data-theme="b" value="Submit" /></div> -->
<!--                     <div class="ui-block-b"><input type="button" id="cancel" data-icon="delete" data-theme="b" value="Cancel" /></div>      -->
<!--                 </fieldset> -->
            </form>
        </div> 
    </div>
    
    </body>
</html>        
</apex:page>