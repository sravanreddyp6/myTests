<apex:page controller="identityEditNew" sidebar="false" id="identityEditNew" tabStyle="TMN_User__c" docType="html-5.0">
    <apex:includeScript value="{!URLFOR($Resource.jquery, 'js/jquery-1.7.2.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.jquery, 'js/jquery-ui-1.8.21.custom.min.js')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.JqUI, '/jquery-ui.css')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.mentoresd,'/mentoresd.css')}" />

    <style type="text/css">
        .custPopup{
            background-color: white;
            border-width: 2px;
            border-style: solid;
            z-index: 9999;
            left: 50%;
            padding:10px;
            position: absolute;
            /* These are the 3 css properties you will need to change so the popup 
            displays in the center of the screen. First set the width. Then set 
            margin-left to negative half of what the width is. You can add 
            the height property for a fixed size pop up if you want.*/
            width: 500px;
            margin-left: -250px;
            top:100px;
        }
        .popupBackground{
            background-color:black;
            opacity: 0.20;
            filter: alpha(opacity = 20);
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 9998;
        }
    .ui-autocomplete-loading { background: white url('{!URLFOR($Resource.AjaxLoad)}') right center no-repeat; }
    </style>
    <script type="text/javascript" >
    
      var j$ = jQuery.noConflict(); 
 var currentUrl = window.location.href;
 currentUrl = currentUrl.substring(0, currentUrl.indexOf("/identity_edittmnu"));
 var sourcePage = currentUrl +'/TMNUser_JSON?core.apexpages.devmode.url=0&identityPage=yes';
 j$(function() {
   var txtVal =  j$('input[id$=locationName]');
    
         j$('input[id$=locationName]').autocomplete({
            source: function( request, response ) {

                //Abort Ajax
                var $this = j$(this);
                var $element = j$(this.element);
                var jqXHR = $element.data('jqXHR');
                if(jqXHR)
                    jqXHR.abort();

                j$('input[id$=locationName]').addClass('ui-autocomplete-loading');
                $element.data('jqXHR',j$.ajax({
                    url: sourcePage+'&location='+txtVal.val(),
                    dataType: "json",
                    data: {
                    },
                    success: function( data ) {
                        response( j$.map( data , function( item ) {
                            return {
                                label: '<a>'+
                                item.location+"<br />"+
                                '<span style="font-size:0.8em;font-style:italic">'
                                +item.location +', '+item.state +"</span></a>",
                                value: item.location
                            }
                        }));
                    },
                    complete: function() {
                        $this.removeData('jqXHR');
                        j$('input[id$=locationName]').removeClass('ui-autocomplete-loading');
                    }
                })
                );

            },
            focus: function() {
                return false;
            },
            select: function(event, ui) {
                var selectedObj = ui.item;
                 // j$('input[id$="ExportToExcel"]').prop('disabled', false)
                setLocationDetails(selectedObj.value);
                return true;
            }
        }).data("autocomplete")._renderItem = autoCompleteRender;

    });

function autoCompleteRender(ul, item) {
    return j$("<li></li>").data("item.autocomplete", item).append(item.label).appendTo(ul);
}  
    function checkUndefined(field) {
        if (field !== undefined) {
            return field;
        }
        return " ";
    }
    
    function setLocationDetails(locationId) {
                Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.identityEditNew.LocationDetails}',
                locationId,
                function (result, event) {
                    if (event.status) { // Success
                        j$('[id$=locationLine1]').val(checkUndefined(result.Office_Location__c));
                        j$('[id$=locationLine2]').val(checkUndefined(result.Office_Location_2__c));
                        j$('[id$=locationCity]').val(checkUndefined(result.Work_City__c));
                        j$('[id$=locationState]').val(checkUndefined(result.Work_State__c));                                                      
                        j$('[id$=locationZip]').val(checkUndefined(result.Zip_Code__c));
                        
                    } else if (event.type === 'exception') {
                        console.log(event);
                    } 
                }
            );

    
    }
    
    
        j$(function() {
    j$('[id*=AttachmentsModel]').dialog({
      resizable: false,
      draggable: false,
      height:180,
      width : 750,
      modal: true,
      autoOpen: false
    }).parent().appendTo(j$('form[id$=identity_edittmnu]'));
});
    
    
    function showAttchment() {
       
     j$('[id*=AttachmentsModel]').dialog("open");
    }
    
    function closeDiglog() {
    j$('[id*=AttachmentsModel]').dialog("close");
    }
    
    
    // function showEditDialog (attId){
           //     alert(attId);
    // j$('[id*=attachmentDeatils]').dialog("open");
    // }
    
    function closeEditDialog (){
      j$('[id*=attachmentDeatils]').dialog("close");
    }  
    var attchmentId =''; 
    function deleteFile(attId){
        attchmentId = attId;
        j$('[id*=dialog-confirm]').dialog("open");
        alert(attchmentId);
 }

 j$(function() {
    j$('[id*=dialog-confirm]').dialog({
      resizable: false,
      height:180,
      modal: true,
      autoOpen: false,
      buttons: {
        Yes: function() {
            j$( this ).dialog( "close" );
            alert(attchmentId)
          deleteattachment(attchmentId);         
        },
        No: function() {
            j$( this ).dialog( "close" );
        }
      }
    });
});
  
    
  function showEditDialog (attId){
    j$('[id*=attachmentDeatils]').dialog("open");
      attachmentDeatils(attId);
    }
    
    function closeEditDialog (){
      j$('[id*=attachmentDeatils]').dialog("close");
    } 
    
 j$(function() {
    j$('[id*=attachmentDeatils]').dialog({
      resizable: false,
      draggable: false,
      height:180,
      width : 750,
      modal: true,
      autoOpen: false
    });
});
    
    </script>      
        <apex:form id="identity_edittmnu">
       <apex:actionFunction name="attachmentDeatils" action="{!attachmentDeatils}"   >
        <apex:param name="kiran" value="" assignTo="{!attchmentId}" />
      </apex:actionFunction>  
        <apex:actionFunction name="deleteattachment" action="{!deleteattachment}"  >
        <apex:param name="attchmentId" value="" assignTo="{!attchmentId}" />
      </apex:actionFunction>
            
            <apex:pageBlock title="TMN User" mode="edit" >
                <apex:pageMessages />
                <apex:pageblockButtons location="Bottom" >    
                    <apex:commandButton value="Save" action="{!Save}"/>
                    <apex:commandButton value="Cancel" action="{!goCancel}" immediate="true" html-formnovalidate="formnovalidate"/>
                </apex:pageblockButtons>            
                <apex:pageBlockSection columns="2" title="{!TMNUser.Name} Information">
                    <apex:inputField label="First Name" value="{!TMNUser.First_Name__c}" required="true" taborderhint="1"/>
                    <apex:outputField label="Company Email" value="{!TMNUser.Email__c}"/>
                    <apex:inputField label="Middle Name" value="{!TMNUser.Middle_Name__c}" taborderhint="2"/>
                    <apex:inputField label="Personal Email" value="{!TMNUser.Personal_Email__c}" taborderhint="9"/>
                    <apex:inputField label="Last Name" value="{!TMNUser.Last_Name__c}" required="true" taborderhint="3"/>
                    <apex:inputField label="Professional Title" value="{!TMNUser.Professional_Title__c}" taborderhint="10"/>
                    <apex:inputField label="Preferred First Name" value="{!TMNUser.Preferred_First_Name__c}" required="true" taborderhint="4"/>                    
                    <apex:inputField label="Start Date" value="{!TMNUser.Hire_Date__c}" required="true" taborderhint="11"/>
                    <apex:inputField label="Preferred Last Name" value="{!TMNUser.Preferred_Last_Name__c}" required="true" taborderhint="5"/>                    
                    <apex:inputField label="End Date" value="{!TMNUser.Last_Day__c}" required="false" taborderhint="12"/>
                    <apex:inputField label="Office Phone" value="{!TMNUser.Office_Phone__c}" type="tel" taborderhint="6"/>
                    <apex:pageBlockSectionItem />
                    <apex:inputField label="Mobile Phone" value="{!TMNUser.Mentor_Cell_Phone__c}" taborderhint="7"/>
                    
               </apex:pageBlockSection>
               <apex:actionRegion >
               <apex:pageBlockSection columns="2" title="Management Hierarchy" id="aliasDetails" >
                    <apex:inputField label="Alias" value="{!TMNUser.Alias_Lookup__c}" taborderhint="13">
                        <apex:actionSupport event="onchange" action="{!updateAliasInfo}" rerender="aliasDetails"/>
                    </apex:inputField>
                    <apex:outputField label="Service Line" value="{!TMNUser.Service_Line__c}"/> 
                    <apex:selectList label="Operating Group" value="{!TMNUser.Operating_Group__c}" size="1" required="true" tabindex="16">
                        <apex:selectOption itemValue="Adult Health Services" itemLabel="Adult Health Services"/>
                        <apex:selectOption itemValue="Care Meridian" itemLabel="Care Meridian"/>
                        <apex:selectOption itemValue="Corporate" itemLabel="Corporate"/>
                        <apex:selectOption itemValue="Cambridge" itemLabel="Hastings"/>                       
                        <apex:selectOption itemValue="NeuroRestorative" itemLabel="NeuroRestorative"/>
                        <apex:selectOption itemValue="Redwood" itemLabel="Redwood"/>
                    </apex:selectList>                                                                                                                                                              
                    <apex:outputField label="Business Unit" value="{!TMNUser.Business_Unit__c}"/>                    
                    <apex:outputField label="Service Region" value="{!TMNUser.Service_Region__c}"/>
                    <apex:outputField label="Program String" value="{!TMNUser.Program_String__c}"/>                    
                </apex:pageBlockSection>
                </apex:actionRegion>
                <apex:pageBlockSection columns="2" title="Location">
                    <apex:inputField label="Location Name" value="{!TMNUser.Location_Name__c}" required="true" taborderhint="15" id="locationName"/>
                    <apex:inputField label="State" value="{!TMNUser.Work_State__c}" id="locationState"/>
                    <apex:inputField label="Address Line 1" value="{!TMNUser.Office_Location__c}" id="locationLine1" />
                    <apex:inputField label="Zip Code" value="{!TMNUser.Zip_Code__c}" id="locationZip"/>
                    <apex:inputField label="Address Line 2" value="{!TMNUser.Office_Location_2__c}" id="locationLine2"/>
                    <apex:inputField label="Office Location" value="{!TMNUser.Office_Location_PickList__c}" taborderhint="14" />            
                    <apex:inputField label="City" value="{!TMNUser.Work_City__c}" id="locationCity"/>     
                    
                </apex:pageBlockSection>
                   
                   <apex:pageBlockSection columns="2" title="Manager Information" id="mngInfo" >                                                                                                                                                                                                                                        
                    <apex:inputField label="Manager Name" value="{!TMNUser.Manager_Lookup__c}" required="true" taborderhint="24"/>
                    <apex:pageBlockSectionItem /> 
                    <apex:inputField label="Vendor" value="{!TMNUser.Vendor_list__c}" required="true" id="vendorList" ></apex:inputField>
                    <apex:pageBlockSectionItem />
                    <apex:inputField label="BAA Signed?" value="{!TMNUser.BAA_Signed__c}" id="BAASigned" />   
                    <input type="button"  value="Add Attachments"  onclick="showAttchment()"   />
                     
                       <apex:outputPanel id="AttachmentsModel" style="display:none">
                          <apex:pageBlock title="Upload Attachments">
                <apex:repeat value="{!newAttachments}" var="newAtt">
                <apex:pageBlockSection columns="2" id="files">
                    <apex:pageBlockSectionItem labelStyle="width: 10%">
                        <apex:inputFile value="{!newAtt.body}" filename="{!newAtt.name}"/> 
                    </apex:pageBlockSectionItem>
                    <apex:pageBlockSectionItem >
                        <apex:outputLabel value="Description"/>
                        <apex:inputText value="{!newAtt.Description}"/>
                    </apex:pageBlockSectionItem>
                </apex:pageBlockSection>
            </apex:repeat>  
                              <apex:commandButton value="Upload" action="{!saveAttachment}"/>
            <apex:commandButton value="Cancel" />
                              
                            
            </apex:pageBlock>                  
            <apex:outputPanel id="datePanelContainer">
            <apex:pageBlock title="Existing Attachments"  >
                <apex:pageBlockTable value="{!attachments}" var="attachment" id="attachmentsTable">
                    <apex:column headerValue="Action">
                       <a href= "#"   onClick="showEditDialog('{!attachment.id}')"> Edit</a> |<a href="#" onclick="deleteattachment('{!attachment.id}');return false;"> Delete </a> 
                    </apex:column>
                    <apex:column style="padding-right: 9px;" headerValue="Title">
                    <apex:outputLink value="/servlet/servlet.FileDownload?file={!attachment.Id}" target="_blank">View file</apex:outputLink>
                </apex:column>
                <apex:column headerValue="Description">{!attachment.Description}</apex:column>
                <apex:column style="padding-right: 9px;" headerValue="Created Date/Time">
                  <apex:outputText value="{0, date, M/d/yyyy h:m a}"><apex:param value="{!attachment.CreatedDate}" /></apex:outputText>
                </apex:column>
                 <apex:column style="padding-right: 9px;" headerValue="Created By">
                    <apex:outputLink value="/{!attachment.OwnerId}">{!attachment.Owner.Name}</apex:outputLink>
                </apex:column>
                </apex:pageBlockTable>
            </apex:pageBlock>
        </apex:outputPanel>

                       </apex:outputPanel>                        
                </apex:pageBlockSection>
                    <apex:outputPanel id="ExistingAttachments">
                  <apex:pageBlock title="Existing Attachments"  >
                <apex:pageBlockTable value="{!attachments}" var="attachment" id="attachmentsTable">
                    <apex:column headerValue="Action">
                       <a href= "#"   onClick="showEditDialog('{!attachment.id}')"> Edit</a> |<a href="#" onclick="deleteFile('{!attachment.id}');return false;"> Delete </a> 
                    </apex:column>
                    <apex:column style="padding-right: 9px;" headerValue="Title">
                    <apex:outputLink value="/servlet/servlet.FileDownload?file={!attachment.Id}" target="_blank">View file</apex:outputLink>
                </apex:column>
                <apex:column headerValue="Description">{!attachment.Description}</apex:column>
                <apex:column style="padding-right: 9px;" headerValue="Created Date/Time">
                  <apex:outputText value="{0, date, M/d/yyyy h:m a}"><apex:param value="{!attachment.CreatedDate}" /></apex:outputText>
                </apex:column>
                 <apex:column style="padding-right: 9px;" headerValue="Created By">
                    <apex:outputLink value="/{!attachment.OwnerId}">{!attachment.Owner.Name}</apex:outputLink>
                </apex:column>
                </apex:pageBlockTable>
            </apex:pageBlock>
        </apex:outputPanel>
                
                <apex:outputPanel id="attachmentDeatils"  style="display:none" title="Attachment Information">
                     <apex:pageBlock >
                        <apex:pageBlockSection columns="2">   
                            <apex:outputText label="File Name">{!attDeatils.Name}</apex:outputText>
                            <apex:inputText label="Description">{!attDeatils.Description}</apex:inputText>
                            <apex:outputText label="Size">{!attDeatils.Name}</apex:outputText>
                            <apex:outputText label="Attachment Owner">{!attDeatils.Owner.Name}</apex:outputText>
                            <apex:outputText label="Created By">{!attDeatils.CreatedBy.Name}</apex:outputText>
                            <apex:outputText label="Modified By">{!attDeatils.LastModifiedBy.name}</apex:outputText>
                    </apex:pageBlockSection> 
                         <apex:pageblockButtons location="Bottom" >    
                    <apex:commandButton value="Save"/>
                    <apex:commandButton value="Cancel"  />
                </apex:pageblockButtons>  
            </apex:pageBlock>
        </apex:outputPanel>
                
            </apex:pageBlock>
        </apex:form>
        <div id="dialog-confirm" class="dialog" title="Delete Attachment?"  style="display:none">
        <p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>Are you sure you want to delete this attachment?</p>
    </div>
</apex:page>